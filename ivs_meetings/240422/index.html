<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>skais, SKACH &amp; SKAO</title>
<meta name="author" content="Philipp Denzel"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="file:///Users/phdenzel/local/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="file:///Users/phdenzel/local/reveal.js/dist/theme/phdcolloq.css" id="theme"/>

<link rel="stylesheet" href="./assets/css/slides.css"/>

<link rel="stylesheet" href="./assets/css/header.css"/>

<link rel="stylesheet" href="./assets/css/footer.css"/>
<meta name="description" content="">
<script src="./assets/js/tsparticles.slim.bundle.min.js"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-background="./assets/images/poster_skach_skao.png" data-background-size="contain" data-background-position="block" data-background-opacity="0.6">
<div id="tsparticles"></div>
<script>
tsParticles.load("tsparticles", {particles: {color: {value: "#ffffff"}, move: {enable: true, speed: 0.4, straight: false}, number: {density: {enable: true}, value: 500}, size: {random: true, value: 3}, opacity: {animation: {enable: true}, value: {min: 0.2, max: 1}}}})
.then(container => {console.log("callback - tsparticles config loaded");})
.catch(error => {console.error(error);});
</script>
<div style="padding-top: 200px"></div>
<h3>skais, SKACH &amp; SKAO<h3>
<h4></h4>
<div style="padding-top: 50px">2024/04/22 </br> IVS group meeting</div>
</section>
<section>
<section id="slide-org64e8e65">
<div class="slide-header"><div style="height:100px"></div></div>
<h2 id="org64e8e65">SKACH news</h2>
<ul>
<li><a href="#/slide-org049ea8b" class="forwardlink">SKACH spring meeting</a></li>
<li><a href="#/slide-org930a8a0" class="forwardlink">MWA members</a></li>
<li><a href="#/slide-org28d6646" class="forwardlink">SKACH at Fantasy Basel</a></li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org049ea8b">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org049ea8b">SKACH spring meeting</h3>
<ul>
<li>Register (for free in case you're interested):
<ul>
<li><a href="https://indico.skatelescope.org/event/1160/">SKACH Spring Meeting 2024</a></li>

</ul></li>
<li>@ ZHAW (Winterthur, TN): 10-11 June, 2024</li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org930a8a0">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org930a8a0">MWA membership</h3>
<ul>
<li>We're MWA members now! Access to embargoed raw data</li>
<li>First Swiss <a href="https://indico.mwatelescope.org/event/12/overview">MWA meeting @ EPFL</a> (Lausanne): 28-30 August, 2024</li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org28d6646">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org28d6646">SKACH at Fantasy Basel</h3>
<ul>
<li>Swiss ComicCon: <a href="https://fantasybasel.ch/en">Fantasy Basel</a> on 9-11 May, 2024</li>
<li>Science exhibition:
<ul>
<li>James Webb replica</li>
<li>astronaut Claude Nicollier</li>
<li>ESA, Swiss space industry startups, &#x2026;</li>
<li>and more</li>

</ul></li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org07472bc">
<div class="slide-header"><div style="height:100px"></div></div>
<h2 id="org07472bc">SKAO news</h2>
<p>
 <br> 
Still in construction&#x2026;
</p>

<p>
FAQ: how can we estimate performance?
</p>

<ul>
<li><a href="#/slide-orgfc62b55" class="forwardlink">Prototypes</a></li>
<li><a href="#/slide-org51d637c" class="forwardlink">Theoretical understanding &amp; experience</a></li>
<li><a href="#/slide-org757bd4d" class="forwardlink">Simulations</a></li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgfc62b55">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgfc62b55">Prototype</h3>

<div id="org4cff3af" class="figure">
<p><img src="./assets/images/ska/SKA_MPI_prototype.png" alt="SKA_MPI_prototype.png" height="830px" style="border-radius: 12px;" />
</p>
<p><span class="figure-number">Figure 1: </span>Credits: SKAO, MPI</p>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgc20e9c3">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgc20e9c3">First light</h3>

<div id="org8b0690f" class="figure">
<p><img src="./assets/images/ska/SKA_MPI_first_light.png" alt="SKA_MPI_first_light.png" height="830px" style="border-radius: 12px;" />
</p>
<p><span class="figure-number">Figure 2: </span>Credits: SKAO, MPI</p>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org51d637c" class="upperh" data-background-video="./assets/movies/radio_dish_scheme.mp4" data-background-video-loop data-background-video-muted data-background-size="contain";>
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org51d637c">Radio sky</h3>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div>
\begin{equation}
  V_{pq} = \int_{4\pi} g_{p}(r)\ B(r)\ g^{\ast}_{q}(r) e^{-\frac{2\pi}{\lambda}\langle\vec{p}-\vec{q}, \vec{r}\rangle} \text{d}\Omega
\end{equation}

</div>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org0a388c4" class="upperh" data-background-video="./assets/movies/radio_dish_scheme.mp4" data-background-video-loop data-background-video-muted data-background-size="contain";>
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org0a388c4">Radio sky (tensorial form)</h3>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div>
\begin{equation}
  V = G^{\ast}\ B\ G
\end{equation}

</div>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgc83af81" class="upperh" data-background-video="./assets/movies/radio_dish_scheme.mp4" data-background-video-loop data-background-video-muted data-background-size="contain";>
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgc83af81">Radio sky (inverse problem)</h3>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div>
\begin{equation}
  y = F_{\theta}\odot x \quad\quad \text{or} \quad\quad y = G_{\eta} \odot F_{\theta}\odot x
\end{equation}

</div>
<p>
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
 <br> 
</p>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org757bd4d">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org757bd4d">Simulating observations: Karabo</h3>

<div id="orgbb332ba" class="figure">
<p><img src="./assets/images/skach/Karabo_lego.png" alt="Karabo_lego.png" height="700px" style="border-radius: 12px;" />
</p>
<p><span class="figure-number">Figure 3: </span>Credits: <a href="https://github.com/i4Ds/Karabo-Pipeline">Karabo</a></p>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orga125d80">
<div class="slide-header"><div style="height:100px"></div></div>
<h2 id="orga125d80">Data, code, and stuff</h2>
<p>
Simulating the sky: Hydrodynamical simulations
</p>
<ul>
<li>point clouds, aka smooth particles</li>
<li>gravity</li>
<li>hydrodyanmical friction (for visible matter, aka baryons)</li>
<li>"sub-grid models" for electro-weak force effects
<ul>
<li>supernovae</li>
<li>accreting black-holes</li>
<li>neutrinos</li>
<li>&#x2026;</li>

</ul></li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org520c895" class="upperh" data-background-video="./assets/movies/illustris/tng100_sb0_inside_bfield_1080p.mp4" data-background-video-muted data-background-size="fill" data-background-opacity="0.8">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org520c895">Simulations</h3>
<p class="header-item">
B-field (TNG100), Credit: IllustrisTNG
</p>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgee2708b">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgee2708b">Projections</h3>
<p>
Cython code
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">skais.raytrace</span>
<span style="color: #44BC84;">"""</span>
<span style="color: #E83A82;">from</span> scipy.integrate <span style="color: #E83A82;">import</span> quad
<span style="color: #E83A82;">import</span> numpy <span style="color: #E83A82;">as</span> np
cimport numpy <span style="color: #E83A82;">as</span> np
cimport cython
<span style="color: #E83A82;">from</span> libc.math cimport sqrt, M_PI, sin, cos, floor, fabs
<span style="color: #E83A82;">from</span> libc.stdio cimport printf
<span style="color: #E83A82;">from</span> libc.time cimport time_t, time, difftime

np.import_array()

<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cpdef void PCS(np.float32_t[:, :] pos, np.float32_t[:, :, :] number, <span style="color: #46D9FF;">float</span> box_size):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Compute the density field of a cubic distribution of particles</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      pos (float[:, ::1]):</span>
<span style="color: #44BC84;">        Particle 3D/2D position array (contiguous)</span>
<span style="color: #44BC84;">      number (float[:, :, ::1]):</span>
<span style="color: #44BC84;">        Density field array (contiguous)</span>
<span style="color: #44BC84;">      box_size (float):</span>
<span style="color: #44BC84;">        Size of the region (edge length)</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">int</span> axis, dims, minimum, j, l, m, n, coord
    cdef <span style="color: #46D9FF;">long</span> i, particles
    cdef <span style="color: #46D9FF;">float</span> inv_cell_size, dist, diff
    cdef <span style="color: #46D9FF;">float</span> C[3][4]
    cdef <span style="color: #46D9FF;">int</span> index[3][4]

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find number of particles, the inverse of the cell size and dims</span>
    <span style="color: #FDB760;">particles</span> = pos.shape[0]
    <span style="color: #FDB760;">coord</span> = pos.shape[1]
    <span style="color: #FDB760;">dims</span> = number.shape[0]
    <span style="color: #FDB760;">inv_cell_size</span> = dims/box_size

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define arrays: for 2D set we have C[2, :] = 1.0 and index[2, :] = 0</span>
    <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(3):
        <span style="color: #E83A82;">for</span> j <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(4):
            C[i][j] = 1.0
            index[i][j] = 0

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over all particles</span>
    <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over the three axes of the particle</span>
        <span style="color: #E83A82;">for</span> axis <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(coord):
            <span style="color: #FDB760;">dist</span> = pos[i, axis] * inv_cell_size
            <span style="color: #FDB760;">minimum</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;floor(dist - 2.0)
            <span style="color: #E83A82;">for</span> j <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(4):  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">only 4 cells/dimension can contribute</span>
                index[axis][j] = (minimum + j + 1 + dims) % dims
                <span style="color: #FDB760;">diff</span> = fabs(minimum + j+1 - dist)
                <span style="color: #E83A82;">if</span> diff&lt;1.0:
                    C[axis][j] = (4.0 - 6.0*diff*diff + 3.0*diff*diff*diff)/6.0
                <span style="color: #E83A82;">elif</span> diff&lt;2.0:
                    C[axis][j] = (2.0 - diff)*(2.0 - diff)*(2.0 - diff)/6.0
                <span style="color: #E83A82;">else</span>:
                    C[axis][j] = 0.0

        <span style="color: #E83A82;">for</span> l <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(4):
            <span style="color: #E83A82;">for</span> m <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(4):
                <span style="color: #E83A82;">for</span> n <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(4):
                    number[index[0][l], index[1][m], index[2][n]] += C[0][l]*C[1][m]*C[2][n]


<span style="color: #8A8A8A;">###############################################################################</span>
<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cpdef void voronoi_NGP_2D(double[:, ::1] field,
                          np.float32_t[:, :] pos,
                          <span style="color: #46D9FF;">float</span>[::1] mass,
                          <span style="color: #46D9FF;">float</span>[::1] radius,
                          <span style="color: #46D9FF;">float</span> x_min, <span style="color: #46D9FF;">float</span> y_min,
                          <span style="color: #46D9FF;">float</span> box_size,
                          <span style="color: #46D9FF;">long</span> tracers, <span style="color: #46D9FF;">int</span> r_divisions,
                          bint periodic,
                          bint verbose=1):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Compute the density field in a 2D region from a set of Voronoi</span>
<span style="color: #44BC84;">    cells that have masses and radii. Each particle is assumed to be a</span>
<span style="color: #44BC84;">    uniform sphere which is associated to the grid itself, divided</span>
<span style="color: #44BC84;">    into shells that have the same area. Shells are then associated to</span>
<span style="color: #44BC84;">    a number (particles-per-cell) of tracers equally distributed in</span>
<span style="color: #44BC84;">    angle. Grid cells are then assigned subparticles according to the</span>
<span style="color: #44BC84;">    NGP (nearest grid point) mass assignment scheme.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      field (double[:, ::1]):</span>
<span style="color: #44BC84;">        The column density field array (contiguous)</span>
<span style="color: #44BC84;">      pos (float[:, ::1]):</span>
<span style="color: #44BC84;">        Particle 3D/2D position array (contiguous)</span>
<span style="color: #44BC84;">      mass (float[::1]):</span>
<span style="color: #44BC84;">        Particle mass array (contiguous)</span>
<span style="color: #44BC84;">      radius (float[::1]):</span>
<span style="color: #44BC84;">        SPH particle radius array (contiguous)</span>
<span style="color: #44BC84;">      x_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the first axis</span>
<span style="color: #44BC84;">      y_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the second axis</span>
<span style="color: #44BC84;">      box_size (float):</span>
<span style="color: #44BC84;">        Size of the region (edge length)</span>
<span style="color: #44BC84;">      tracers (long):</span>
<span style="color: #44BC84;">        TODO</span>
<span style="color: #44BC84;">      r_divisions (int):</span>
<span style="color: #44BC84;">        TODO</span>
<span style="color: #44BC84;">      periodic (bool):</span>
<span style="color: #44BC84;">        If True, periodic boundary conditions are applied</span>
<span style="color: #44BC84;">      verbose (bool):</span>
<span style="color: #44BC84;">        Print debug info</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">long</span> i, j, k, particles, dims, count
    cdef double dtheta, angle, R, R1, R2, area, length, V_sphere, norm
    cdef double R_cell, W_cell, x_cell, y_cell
    cdef np.float32_t[:, :] pos_tracer
    cdef np.float32_t[:] w_tracer
    cdef double x, y, w, inv_cell_size
    cdef <span style="color: #46D9FF;">int</span> index_x, index_y, index_xp, index_xm, index_yp, index_ym
    cdef <span style="color: #46D9FF;">int</span> theta_divisions
    cdef time_t start
    cdef double duration

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">verbose</span>
    <span style="color: #E83A82;">if</span> verbose:
        printf(<span style="color: #44BC84;">"Computing projected mass of the Voronoi tracers...</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>)
    <span style="color: #FDB760;">start</span> = time(NULL)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the number of particles, dimensions of the grid</span>
    <span style="color: #FDB760;">particles</span>     = pos.shape[0]
    <span style="color: #FDB760;">dims</span>          = field.shape[0]
    <span style="color: #FDB760;">inv_cell_size</span> = dims * 1.0 / box_size
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">compute the number of particles in each shell and the angle between them</span>
    <span style="color: #FDB760;">theta_divisions</span> = tracers // r_divisions
    <span style="color: #FDB760;">dtheta</span>          = 2.0 * M_PI / theta_divisions
    <span style="color: #FDB760;">V_sphere</span>        = 4.0/3.0 * M_PI * 1.0**3
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define the arrays with the properties of the tracers; positions and weights</span>
    <span style="color: #FDB760;">pos_tracer</span> = np.zeros((tracers, 2), dtype=np.float32)
    <span style="color: #FDB760;">w_tracer</span>   = np.zeros(tracers, dtype=np.float32)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define and fill the array containing pos_tracer</span>
    <span style="color: #FDB760;">count</span> = 0
    <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(r_divisions):
        <span style="color: #FDB760;">R1</span> = i * 1.0 / r_divisions
        <span style="color: #FDB760;">R2</span> = (i + 1.0) / r_divisions
        <span style="color: #FDB760;">R</span> = 0.5 * (R1 + R2)
        <span style="color: #FDB760;">area</span> = M_PI * (R2**2 - R1**2) / theta_divisions
        <span style="color: #FDB760;">length</span> = 2.0 * sqrt(1.0**2 - R**2)
        <span style="color: #E83A82;">for</span> j <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(theta_divisions):
            <span style="color: #FDB760;">angle</span> = 2.0 * M_PI * (j + 0.5) / theta_divisions
            <span style="color: #FDB760;">pos_tracer</span>[count, 0] = R * cos(angle)
            <span style="color: #FDB760;">pos_tracer</span>[count, 1] = R * sin(angle)
            <span style="color: #FDB760;">w_tracer</span>[count] = area * length / V_sphere
            <span style="color: #FDB760;">count</span> += 1
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">normalize weights of tracers</span>
    <span style="color: #FDB760;">norm</span> = np.<span style="color: #46D9FF;">sum</span>(w_tracer, dtype=np.float64)
    <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(tracers):
        <span style="color: #FDB760;">w_tracer</span>[i] = w_tracer[i] / norm
    <span style="color: #E83A82;">if</span> periodic:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #FDB760;">R_cell</span> = radius[i]
            <span style="color: #FDB760;">W_cell</span> = mass[i]
            <span style="color: #FDB760;">x_cell</span> = pos[i, 0]
            <span style="color: #FDB760;">y_cell</span> = pos[i, 1]
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">see if we need to split the particle into tracers or not</span>
            <span style="color: #FDB760;">index_xm</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((x_cell - R_cell - x_min) * inv_cell_size + 0.5)
            <span style="color: #FDB760;">index_xp</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((x_cell + R_cell - x_min) * inv_cell_size + 0.5)
            <span style="color: #FDB760;">index_ym</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((y_cell - R_cell - y_min) * inv_cell_size + 0.5)
            <span style="color: #FDB760;">index_yp</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((y_cell + R_cell - y_min) * inv_cell_size + 0.5)
            <span style="color: #E83A82;">if</span> (index_xm == index_xp) <span style="color: #E83A82;">and</span> (index_ym == index_yp):
                <span style="color: #FDB760;">index_x</span> = (index_xm + dims) % dims
                <span style="color: #FDB760;">index_y</span> = (index_ym + dims) % dims
                <span style="color: #FDB760;">field</span>[<span style="color: #FDB760;">index_x</span>, <span style="color: #FDB760;">index_y</span>] += W_cell
            <span style="color: #E83A82;">else</span>:
                <span style="color: #E83A82;">for</span> j <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(tracers):
                    <span style="color: #FDB760;">x</span> = x_cell + R_cell * pos_tracer[j, 0]
                    <span style="color: #FDB760;">y</span> = y_cell + R_cell * pos_tracer[j, 1]
                    <span style="color: #FDB760;">w</span> = W_cell * w_tracer[j]
                    <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((x - x_min) * inv_cell_size + 0.5)
                    <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((y - y_min) * inv_cell_size + 0.5)
                    <span style="color: #FDB760;">index_x</span> = (index_x + dims) % dims
                    <span style="color: #FDB760;">index_y</span> = (index_y + dims) % dims
                    <span style="color: #FDB760;">field</span>[<span style="color: #FDB760;">index_x</span>, <span style="color: #FDB760;">index_y</span>] += w
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">no boundary conditions</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #FDB760;">R_cell</span> = radius[i]
            <span style="color: #FDB760;">W_cell</span> = mass[i]
            <span style="color: #FDB760;">x_cell</span> = pos[i, 0]
            <span style="color: #FDB760;">y_cell</span> = pos[i, 1]
            <span style="color: #E83A82;">for</span> j <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(tracers):
                <span style="color: #FDB760;">x</span> = x_cell + R_cell * pos_tracer[j, 0]
                <span style="color: #FDB760;">y</span> = y_cell + R_cell * pos_tracer[j, 1]
                <span style="color: #FDB760;">w</span> = W_cell * w_tracer[j]
                <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((x - x_min) * inv_cell_size + 0.5)
                <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((y - y_min) * inv_cell_size + 0.5)
                <span style="color: #E83A82;">if</span> (index_x &lt; 0) <span style="color: #E83A82;">or</span> (index_x &gt;= dims):
                    <span style="color: #E83A82;">continue</span>
                <span style="color: #E83A82;">if</span> (index_y &lt; 0) <span style="color: #E83A82;">or</span> (index_y &gt;= dims):
                    <span style="color: #E83A82;">continue</span>
                <span style="color: #FDB760;">field</span>[<span style="color: #FDB760;">index_x</span>, <span style="color: #FDB760;">index_y</span>] += w
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #FDB760;">duration</span> = difftime(time(NULL), start)
        printf(<span style="color: #44BC84;">"Time taken = %.2f seconds</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>, duration)


<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cpdef void voronoi_RT_2D(double[:, ::1] density,
                         <span style="color: #46D9FF;">float</span>[:, ::1] pos,
                         <span style="color: #46D9FF;">float</span>[::1] mass,
                         <span style="color: #46D9FF;">float</span>[::1] radius,
                         <span style="color: #46D9FF;">float</span> x_min, <span style="color: #46D9FF;">float</span> y_min,
                         <span style="color: #46D9FF;">float</span> box_size,
                         <span style="color: #46D9FF;">int</span> axis_x, <span style="color: #46D9FF;">int</span> axis_y,
                         bint periodic,
                         bint verbose=1):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Compute the 2D density field from a set of Voronoi cells in 3D</span>
<span style="color: #44BC84;">    that have masses and radii assuming they represent uniform</span>
<span style="color: #44BC84;">    spheres.  A cell that intersects with a cell will increase its</span>
<span style="color: #44BC84;">    value by the column density of the cell along the sphere. The</span>
<span style="color: #44BC84;">    density array contains the column densities in M/(L/h)^2 units if</span>
<span style="color: #44BC84;">    the quantities in mass units (M) are given in M/h and length units</span>
<span style="color: #44BC84;">    (L) in L/h.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      density (double[:, ::1]):</span>
<span style="color: #44BC84;">        The column density field array (contiguous)</span>
<span style="color: #44BC84;">      pos (float[:, ::1]):</span>
<span style="color: #44BC84;">        Particle 3D/2D position array (contiguous)</span>
<span style="color: #44BC84;">      mass (float[::1]):</span>
<span style="color: #44BC84;">        Particle mass array (contiguous)</span>
<span style="color: #44BC84;">      radius (float[::1]):</span>
<span style="color: #44BC84;">        SPH particle radius array (contiguous)</span>
<span style="color: #44BC84;">      x_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the first axis</span>
<span style="color: #44BC84;">      y_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the second axis</span>
<span style="color: #44BC84;">      box_size (float):</span>
<span style="color: #44BC84;">        Size of the region (edge length)</span>
<span style="color: #44BC84;">      axis_x (int):</span>
<span style="color: #44BC84;">        Coordinate projected along the x-axis [x=0, y=1, z=2]</span>
<span style="color: #44BC84;">      axis_x (int):</span>
<span style="color: #44BC84;">        Coordinate projected along the y-axis [x=0, y=1, z=2]</span>
<span style="color: #44BC84;">      periodic (bool):</span>
<span style="color: #44BC84;">        If True, periodic boundary conditions are applied</span>
<span style="color: #44BC84;">      verbose (bool):</span>
<span style="color: #44BC84;">        Print debug info</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">long</span> particles, i
    cdef <span style="color: #46D9FF;">int</span> dims, index_x, index_y, index_R, ii, jj, i_cell, j_cell
    cdef <span style="color: #46D9FF;">float</span> x, y, rho, cell_size, inv_cell_size, radius2
    cdef <span style="color: #46D9FF;">float</span> dist2, dist2_x
    cdef time_t start
    cdef double duration
    <span style="color: #FDB760;">start</span> = time(NULL)

    <span style="color: #E83A82;">if</span> verbose:
        printf(<span style="color: #44BC84;">"Computing column densities of the particles...</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the number of particles and the dimensions of the grid</span>
    <span style="color: #FDB760;">particles</span> = pos.shape[0]
    <span style="color: #FDB760;">dims</span>      = density.shape[0]
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define cell size and the inverse of the cell size</span>
    <span style="color: #FDB760;">cell_size</span>     = box_size * 1.0 / dims
    <span style="color: #FDB760;">inv_cell_size</span> = dims * 1.0 / box_size
    <span style="color: #E83A82;">if</span> periodic:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the density of the particle and the square of its radius</span>
            <span style="color: #FDB760;">rho</span>     = 3.0 * mass[i] / (4.0 * M_PI * radius[i]**3)  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">h^2 M/L^3</span>
            <span style="color: #FDB760;">radius2</span> = radius[i]**2  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">(L/h)^2</span>
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find cell where the particle center is and its radius in cell units</span>
            <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_x] - x_min) * inv_cell_size)
            <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_y] - y_min) * inv_cell_size)
            <span style="color: #FDB760;">index_R</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(radius[i] * inv_cell_size) + 1
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">loop over the cells that contribute in the x-direction</span>
            <span style="color: #E83A82;">for</span> ii <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                <span style="color: #FDB760;">x</span>       = (index_x + ii) * cell_size + x_min
                <span style="color: #FDB760;">i_cell</span>  = ((index_x + ii + dims) % dims)
                <span style="color: #FDB760;">dist2_x</span> = (x - pos[i, axis_x])**2
                <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">loop over the cells that contribute in the y-direction</span>
                <span style="color: #E83A82;">for</span> jj <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                    <span style="color: #FDB760;">y</span>      = (index_y + jj) * cell_size + y_min
                    <span style="color: #FDB760;">j_cell</span> = ((index_y + jj + dims) % dims)
                    <span style="color: #FDB760;">dist2</span> = dist2_x + (y - pos[i, axis_y])**2
                    <span style="color: #E83A82;">if</span> dist2 &lt; radius2:
                        <span style="color: #FDB760;">density</span>[<span style="color: #FDB760;">i_cell</span>, <span style="color: #FDB760;">j_cell</span>] += 2.0 * rho * sqrt(radius2 - dist2)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">no boundary conditions</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the density of the particle and the square of its radius</span>
            <span style="color: #FDB760;">rho</span>     = 3.0 * mass[i] / (4.0 * M_PI * radius[i]**3)  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">h^2 M/L^3</span>
            <span style="color: #FDB760;">radius2</span> = radius[i]**2  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">(L/h)^2</span>
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find cell where the particle center is and its radius in cell units</span>
            <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_x] - x_min) * inv_cell_size)
            <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_y] - y_min) * inv_cell_size)
            <span style="color: #FDB760;">index_R</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(radius[i] * inv_cell_size) + 1
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">contribution in the x-direction</span>
            <span style="color: #E83A82;">for</span> ii <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                <span style="color: #FDB760;">i_cell</span> = index_x + ii
                <span style="color: #E83A82;">if</span> i_cell &gt;= 0 <span style="color: #E83A82;">and</span> i_cell &lt; dims:
                    <span style="color: #FDB760;">x</span> = i_cell * cell_size + x_min
                    <span style="color: #FDB760;">dist2_x</span> = (x - pos[i, axis_x])**2 
                <span style="color: #E83A82;">else</span>:
                    <span style="color: #E83A82;">continue</span>        
                <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">contribution in the y-direction</span>
                <span style="color: #E83A82;">for</span> jj <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                    <span style="color: #FDB760;">j_cell</span> = index_y + jj
                    <span style="color: #E83A82;">if</span> j_cell &gt;= 0 <span style="color: #E83A82;">and</span> j_cell &lt; dims:
                        <span style="color: #FDB760;">y</span> = j_cell * cell_size + y_min
                    <span style="color: #E83A82;">else</span>:
                        <span style="color: #E83A82;">continue</span>
                    <span style="color: #FDB760;">dist2</span> = dist2_x + (y - pos[i, axis_y])**2
                    <span style="color: #E83A82;">if</span> dist2 &lt; radius2:
                        <span style="color: #FDB760;">density</span>[<span style="color: #FDB760;">i_cell</span>, <span style="color: #FDB760;">j_cell</span>] += 2.0 * rho * sqrt(radius2 - dist2)

    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #FDB760;">duration</span> = difftime(time(NULL), start)
        printf(<span style="color: #44BC84;">"Time taken = %.2f seconds</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>, duration)

<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cdef <span style="color: #46D9FF;">float</span> kernel_SPH(<span style="color: #46D9FF;">float</span> r, <span style="color: #46D9FF;">float</span> R):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    The SPH kernel function</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">float</span> u, prefact
    <span style="color: #FDB760;">u</span> = r / R
    <span style="color: #FDB760;">prefact</span> = 8.0 / (M_PI * R**3)
    <span style="color: #E83A82;">if</span> u &lt; 0.5:
        <span style="color: #E83A82;">return</span> prefact * (1 + (6.0 * u - 6.0) * u**2)
    <span style="color: #E83A82;">elif</span> u &lt;= 1.0:
        <span style="color: #E83A82;">return</span> prefact * 2.0 * (1.0 - u)**3
    <span style="color: #E83A82;">else</span>:
        <span style="color: #E83A82;">return</span> 0.0


<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
cpdef <span style="color: #46D9FF;">float</span> integrand(<span style="color: #46D9FF;">float</span> x, <span style="color: #46D9FF;">float</span> b2):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Integral kernel for scipy.integrate.quad</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">float</span> r
    <span style="color: #FDB760;">r</span> = sqrt(b2 + x**2)
    <span style="color: #E83A82;">return</span> kernel_SPH(r, 1.0)


<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cdef NHI_table(<span style="color: #46D9FF;">int</span> bins):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Compute the integral of the SPH kernel</span>
<span style="color: #44BC84;">    \int_{0}^{lmax} W(r) dl, where b^2 + l^2 = r^2 (b is the impact parameter).</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      bins (int):</span>
<span style="color: #44BC84;">        bins</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">arrays with impact parameter^2 and the column densities</span>
    cdef Py_ssize_t i
    cdef <span style="color: #46D9FF;">float</span> b2, lmax, I, dI
    cdef np.ndarray[np.float64_t, ndim=1] b2s = np.linspace(0, 1, bins, dtype=np.float64)
    cdef np.ndarray[np.float64_t, ndim=1] NHI = np.zeros(bins, dtype=np.float64)
    <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(bins):
        <span style="color: #FDB760;">b2</span> = b2s[i]
        <span style="color: #E83A82;">if</span> b2 == 1.0:
            <span style="color: #E83A82;">continue</span>
        <span style="color: #FDB760;">lmax</span> = sqrt(1.0 - b2)
        <span style="color: #FDB760;">I</span>, <span style="color: #FDB760;">dI</span> = quad(integrand, 0.0, lmax, args=(b2,), epsabs=1e-12, epsrel=1e-12)
        <span style="color: #FDB760;">NHI</span>[i] = 2.0 * I
    <span style="color: #E83A82;">return</span> b2s, NHI


<span style="color: #8A8A8A;">###############################################################################</span>
<span style="color: #FFD787;">@cython.boundscheck</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.wraparound</span>(<span style="color: #8787FF;">False</span>)
<span style="color: #FFD787;">@cython.cdivision</span>(<span style="color: #8787FF;">True</span>)
cpdef void SPH_RT_2D(double[:,::1] density,
                     <span style="color: #46D9FF;">float</span>[:,::1] pos,
                     <span style="color: #46D9FF;">float</span>[::1] mass,
                     <span style="color: #46D9FF;">float</span>[::1] radius,
                     <span style="color: #46D9FF;">float</span> x_min, <span style="color: #46D9FF;">float</span> y_min,
                     <span style="color: #46D9FF;">int</span> axis_x, <span style="color: #46D9FF;">int</span> axis_y,
                     <span style="color: #46D9FF;">float</span> box_size,
                     bint periodic,
                     bint verbose=1):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Compute the 2D density field from a set of SPH particles that have</span>
<span style="color: #44BC84;">    masses and radii assuming they represent uniform spheres.  A cell</span>
<span style="color: #44BC84;">    that intersects with a cell will increase its value by the column</span>
<span style="color: #44BC84;">    density of the cell along the sphere. The density array contains</span>
<span style="color: #44BC84;">    the column densities in M/(L/h)^2 units if the quantities in mass</span>
<span style="color: #44BC84;">    units (M) are given in M/h and length units (L) in L/h.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      density (double[:, ::1]):</span>
<span style="color: #44BC84;">        The column density field array (contiguous)</span>
<span style="color: #44BC84;">      pos (float[:, ::1]):</span>
<span style="color: #44BC84;">        Particle 3D/2D position array (contiguous)</span>
<span style="color: #44BC84;">      mass (float[::1]):</span>
<span style="color: #44BC84;">        Particle mass array (contiguous)</span>
<span style="color: #44BC84;">      radius (float[::1]):</span>
<span style="color: #44BC84;">        SPH particle radius array (contiguous)</span>
<span style="color: #44BC84;">      x_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the first axis</span>
<span style="color: #44BC84;">      y_min (float):</span>
<span style="color: #44BC84;">        Minimum coordinate along the second axis</span>
<span style="color: #44BC84;">      axis_x (int):</span>
<span style="color: #44BC84;">        Coordinate projected along the x-axis [x=0, y=1, z=2]</span>
<span style="color: #44BC84;">      axis_x (int):</span>
<span style="color: #44BC84;">        Coordinate projected along the y-axis [x=0, y=1, z=2]</span>
<span style="color: #44BC84;">      box_size (float):</span>
<span style="color: #44BC84;">        Size of the region (edge length)</span>
<span style="color: #44BC84;">      periodic (bool):</span>
<span style="color: #44BC84;">        If True, periodic boundary conditions are applied</span>
<span style="color: #44BC84;">      verbose (bool):</span>
<span style="color: #44BC84;">        Print debug info</span>
<span style="color: #44BC84;">    """</span>
    cdef <span style="color: #46D9FF;">long</span> <span style="color: #FDB760;">particles</span>, <span style="color: #FDB760;">i</span>, <span style="color: #FDB760;">num</span>, <span style="color: #FDB760;">bins</span> = 1000
    cdef <span style="color: #46D9FF;">int</span> dims, index_x, index_y, index_R, ii, jj, i_cell, j_cell
    cdef <span style="color: #46D9FF;">float</span> x, y, cell_size, inv_cell_size, radius2
    cdef <span style="color: #46D9FF;">float</span> dist2, dist2_x, mass_part
    cdef double[::1] b2, NHI
    cdef time_t start
    cdef double duration
    <span style="color: #FDB760;">start</span> = time(NULL)
    <span style="color: #E83A82;">if</span> verbose:
        printf(<span style="color: #44BC84;">"Computing column densities of the particles...</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the number of particles and the dimensions of the grid</span>
    <span style="color: #FDB760;">particles</span> = pos.shape[0]
    <span style="color: #FDB760;">dims</span>      = density.shape[0]
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define cell size and the inverse of the cell size</span>
    <span style="color: #FDB760;">cell_size</span>     = box_size * 1.0 / dims
    <span style="color: #FDB760;">inv_cell_size</span> = dims * 1.0 / box_size
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">compute the normalized column density for normalized radii^2</span>
    <span style="color: #FDB760;">b2</span>, <span style="color: #FDB760;">NHI</span> = NHI_table(bins)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">periodic boundary conditions</span>
    <span style="color: #E83A82;">if</span> periodic:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the particle mass and the square of its radius</span>
            <span style="color: #FDB760;">radius2</span>   = radius[i]**2  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">(L/h)^2</span>
            <span style="color: #FDB760;">mass_part</span> = mass[i]
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find cell where the particle center is and its radius in cell units</span>
            <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_x] - x_min) * inv_cell_size)
            <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_y] - y_min) * inv_cell_size)
            <span style="color: #FDB760;">index_R</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(radius[i] * inv_cell_size) + 1
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over the cells that contribute in the x-direction</span>
            <span style="color: #E83A82;">for</span> ii <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                <span style="color: #FDB760;">x</span>       = (index_x + ii) * cell_size + x_min
                <span style="color: #FDB760;">i_cell</span>  = ((index_x + ii + dims) % dims)
                <span style="color: #FDB760;">dist2_x</span> = (x - pos[i, axis_x])**2
                <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over the cells that contribute in the y-direction</span>
                <span style="color: #E83A82;">for</span> jj <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                    <span style="color: #FDB760;">y</span>      = (index_y + jj) * cell_size + y_min
                    <span style="color: #FDB760;">j_cell</span> = ((index_y + jj + dims) % dims)
                    <span style="color: #FDB760;">dist2</span> = dist2_x + (y - pos[i, axis_y])**2
                    <span style="color: #E83A82;">if</span> dist2 &lt; radius2:
                        <span style="color: #FDB760;">num</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(dist2 / radius2) * bins
                        <span style="color: #FDB760;">density</span>[<span style="color: #FDB760;">i_cell</span>, <span style="color: #FDB760;">j_cell</span>] += (mass_part * NHI[num])
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">no periodic boundary conditions</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(particles):
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find the particle mass and the square of its radius</span>
            <span style="color: #FDB760;">radius2</span>   = radius[i]**2  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">(L/h)^2</span>
            <span style="color: #FDB760;">mass_part</span> = mass[i]
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">find cell where the particle center is and its radius in cell units</span>
            <span style="color: #FDB760;">index_x</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_x] - x_min) * inv_cell_size)
            <span style="color: #FDB760;">index_y</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;((pos[i, axis_y] - y_min) * inv_cell_size)
            <span style="color: #FDB760;">index_R</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(radius[i] * inv_cell_size) + 1
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over the cells that contribute in the x-direction</span>
            <span style="color: #E83A82;">for</span> ii <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                <span style="color: #FDB760;">i_cell</span> = index_x + ii
                <span style="color: #E83A82;">if</span> (i_cell &gt;= 0) <span style="color: #E83A82;">and</span> (i_cell &lt; dims):
                    <span style="color: #FDB760;">x</span> = i_cell * cell_size + x_min
                <span style="color: #E83A82;">else</span>:
                    <span style="color: #E83A82;">continue</span>
                <span style="color: #FDB760;">dist2_x</span> = (x - pos[i, axis_x])**2
                <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">do a loop over the cells that contribute in the y-direction</span>
                <span style="color: #E83A82;">for</span> jj <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">range</span>(-index_R, index_R+1):
                    <span style="color: #FDB760;">j_cell</span> = index_y + jj
                    <span style="color: #E83A82;">if</span> j_cell &gt;= 0 <span style="color: #E83A82;">and</span> j_cell &lt; dims:
                        <span style="color: #FDB760;">y</span> = j_cell * cell_size + y_min
                    <span style="color: #E83A82;">else</span>:
                        <span style="color: #E83A82;">continue</span>
                    <span style="color: #FDB760;">dist2</span> = dist2_x + (y - pos[i, axis_y])**2
                    <span style="color: #E83A82;">if</span> dist2 &lt; radius2:
                        <span style="color: #FDB760;">num</span> = &lt;<span style="color: #46D9FF;">int</span>&gt;(dist2 / radius2) * bins
                        <span style="color: #FDB760;">density</span>[<span style="color: #FDB760;">i_cell</span>, <span style="color: #FDB760;">j_cell</span>] += (mass_part * NHI[num])
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #FDB760;">duration</span> = difftime(time(NULL), start)
        printf(<span style="color: #44BC84;">'Time taken = %.2f seconds'</span>, duration)
</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgc31acf8">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgc31acf8">Cython integration</h3>
<ul>
<li>bottleneck: data loading
<ul>
<li>search galaxies in data (simulation snapshots 3 TB each)</li>
<li>+600 @ 4GB HDF5 files with particles per snapshot</li>
<li>data of a single galaxy split over 1-4 files</li>

</ul></li>
<li>CPU raytracing good enough (for now)</li>
<li>Cython only compatible with the <code>setuptools</code> build system</li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-orgccb8ae2">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="orgccb8ae2">pyproject.toml</h4>
<div class="org-src-container">

<pre class="src src-conf">[<span style="color: #FFD787;">build-system</span>]
<span style="color: #FDB760;">requires</span> = [<span style="color: #44BC84;">"setuptools"</span>, <span style="color: #44BC84;">"cython"</span>, <span style="color: #44BC84;">"numpy"</span>]
<span style="color: #FDB760;">build-backend</span> = <span style="color: #44BC84;">"setuptools.build_meta"</span>

[<span style="color: #FFD787;">project</span>]
<span style="color: #FDB760;">name</span> = <span style="color: #44BC84;">"skais"</span>
<span style="color: #FDB760;">version</span> = <span style="color: #44BC84;">"0.1.dev1"</span>
<span style="color: #FDB760;">description</span> = <span style="color: #44BC84;">"SKAIs: an AI framework for deep learning SKA radio telescope &amp; cosmological hydrodynamical simulation data"</span>
<span style="color: #FDB760;">readme</span> = {file = <span style="color: #44BC84;">"README.org"</span>, content-type = <span style="color: #44BC84;">"text/plain"</span>}
<span style="color: #FDB760;">requires-python</span> = <span style="color: #44BC84;">"&gt;=3.6"</span>
<span style="color: #FDB760;">license</span> = {file = <span style="color: #44BC84;">"LICENSE"</span>}
<span style="color: #FDB760;">authors</span> = [
  <span style="color: #FDB760;">{name</span> = <span style="color: #44BC84;">"Philipp Denzel"</span>, email = <span style="color: #44BC84;">"phdenzel@gmail.com"</span>},
]
<span style="color: #FDB760;">maintainers</span> = [
  <span style="color: #FDB760;">{name</span> = <span style="color: #44BC84;">"Philipp Denzel"</span>, email = <span style="color: #44BC84;">"phdenzel@gmail.com"</span>},
]
<span style="color: #FDB760;">keywords</span> = [<span style="color: #44BC84;">"pix2pix"</span>, <span style="color: #44BC84;">"deep learning"</span>, <span style="color: #44BC84;">"cosmological simulations"</span>, <span style="color: #44BC84;">"illustris-tng"</span>, <span style="color: #44BC84;">"radio mocks"</span>]
<span style="color: #FDB760;">classifiers</span> = [
    <span style="color: #44BC84;">"Programming Language :: Python :: 3"</span>,
    <span style="color: #44BC84;">"License :: OSI Approved :: GNU General Public License v3 (GPLv3)"</span>,
    <span style="color: #44BC84;">"Operating System :: POSIX :: Linux"</span>,
    <span style="color: #44BC84;">"Operating System :: MacOS"</span>,
    <span style="color: #44BC84;">"Topic :: Security"</span>]

<span style="color: #FDB760;">dependencies</span> = [
    <span style="color: #44BC84;">"numpy"</span>,
    <span style="color: #44BC84;">"scipy"</span>,
    <span style="color: #44BC84;">"tqdm"</span>,
    <span style="color: #44BC84;">"astropy"</span>,
    <span style="color: #44BC84;">"h5py"</span>,
    <span style="color: #44BC84;">"Pillow"</span>,
    <span style="color: #44BC84;">"matplotlib"</span>,
    <span style="color: #44BC84;">"torch"</span>,
    <span style="color: #44BC84;">"torchvision"</span>,
    <span style="color: #44BC84;">"ray[train,tune]"</span>,
    <span style="color: #44BC84;">"wandb"</span>,
    <span style="color: #44BC84;">"torchinfo"</span>,
]

[<span style="color: #FFD787;">project.optional-dependencies</span>]
<span style="color: #FDB760;">utils</span> = [<span style="color: #44BC84;">"jupyter"</span>]
<span style="color: #FDB760;">dev</span> = [<span style="color: #44BC84;">"build"</span>, <span style="color: #44BC84;">"python-config"</span>]
<span style="color: #FDB760;">lsp</span> = [<span style="color: #44BC84;">"python-lsp-server[all]"</span>, <span style="color: #44BC84;">"python-lsp-ruff"</span>, <span style="color: #44BC84;">"pylsp-mypy"</span>, <span style="color: #44BC84;">"pylsp-rope"</span>, <span style="color: #44BC84;">"python-lsp-black"</span>]
<span style="color: #FDB760;">hyperopt</span> = [<span style="color: #44BC84;">"hyperopt"</span>]
<span style="color: #FDB760;">optuna</span> = [<span style="color: #44BC84;">"optuna"</span>]
<span style="color: #FDB760;">tune</span> = [<span style="color: #44BC84;">"skais[hyperopt,optuna]"</span>]

[<span style="color: #FFD787;">project.urls</span>]
<span style="color: #FDB760;">Homepage</span> = <span style="color: #44BC84;">"https://github.com/phdenzel/skais"</span>
<span style="color: #FDB760;">Repository</span> = <span style="color: #44BC84;">"https://github.com/phdenzel/skais.git"</span>
<span style="color: #FDB760;">Issues</span> = <span style="color: #44BC84;">"https://github.com/phdenzel/skais/issues"</span>

[<span style="color: #FFD787;">project.scripts</span>]
<span style="color: #FDB760;">skais</span> = <span style="color: #44BC84;">"skais.__main__:main"</span>

[<span style="color: #FFD787;">tool.setuptools.packages.find</span>]
<span style="color: #FDB760;">exclude</span> = [<span style="color: #44BC84;">"data"</span>, <span style="color: #44BC84;">"notebooks"</span>, <span style="color: #44BC84;">"scripts"</span>, <span style="color: #44BC84;">"requirements"</span>, <span style="color: #44BC84;">"conda"</span>, <span style="color: #44BC84;">"docker"</span>, <span style="color: #44BC84;">"checkpoints"</span>, <span style="color: #44BC84;">"results"</span>, <span style="color: #44BC84;">"wandb"</span>]

<span style="color: #8A8A8A;">#</span><span style="color: #8A8A8A;">[tool.setuptools.package-data]</span>
<span style="color: #8A8A8A;">#</span><span style="color: #8A8A8A;">data = ["*.hdf5"]</span>

</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org9f9d95b">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org9f9d95b">setup.py</h4>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #E83A82;">import</span> sys
<span style="color: #E83A82;">import</span> argparse
<span style="color: #E83A82;">from</span> setuptools <span style="color: #E83A82;">import</span> Extension, setup
<span style="color: #E83A82;">import</span> numpy

<span style="color: #FDB760;">parser</span> = argparse.ArgumentParser(prog=<span style="color: #44BC84;">'python setup.py'</span>,
                                 formatter_class=argparse.RawTextHelpFormatter,
                                 description=<span style="color: #44BC84;">"Build skais extensions.</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>
                                 <span style="color: #44BC84;">"Use `python setup.py build_ext --inplace`</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>
                                 <span style="color: #44BC84;">"for building Cython extensions from their corresponding C files "</span>
                                 <span style="color: #44BC84;">"or</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">`python setup.py build_ext --inplace --use_cython`</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">for building extensions from the cython files directly."</span>)
parser.add_argument(<span style="color: #44BC84;">'--use_cython'</span>, <span style="color: #44BC84;">'--cython'</span>, action=<span style="color: #44BC84;">'store_true'</span>,
                    <span style="color: #46D9FF;">help</span>=<span style="color: #44BC84;">"Build extensions from their cython files "</span>
                    <span style="color: #44BC84;">"instead of the C files."</span>)
parser.add_argument(<span style="color: #44BC84;">'-a'</span>, <span style="color: #44BC84;">'--report'</span>, action=<span style="color: #44BC84;">'store_true'</span>,
                    <span style="color: #46D9FF;">help</span>=<span style="color: #44BC84;">"Generate annotated HTML compilation report."</span>)
parser.add_argument(<span style="color: #44BC84;">'build_c'</span>, nargs=<span style="color: #44BC84;">'?'</span>, default=<span style="color: #44BC84;">''</span>,
                    <span style="color: #46D9FF;">help</span>=<span style="color: #44BC84;">"Compile cython files and exit."</span>)

<span style="color: #FDB760;">args</span>, <span style="color: #FDB760;">unk</span> = parser.parse_known_args()
<span style="color: #FDB760;">USE_CYTHON</span> = args.use_cython
<span style="color: #FDB760;">BUILD_C</span> = args.build_c == <span style="color: #44BC84;">'build_c'</span>

<span style="color: #FDB760;">ext</span> = <span style="color: #44BC84;">'.pyx'</span> <span style="color: #E83A82;">if</span> USE_CYTHON <span style="color: #E83A82;">or</span> BUILD_C <span style="color: #E83A82;">else</span> <span style="color: #44BC84;">'.c'</span>
<span style="color: #FDB760;">extensions</span> = [Extension(name=<span style="color: #44BC84;">"skais.raytrace"</span>, sources=[<span style="color: #44BC84;">"skais/raytrace"</span>+ext],
                        include_dirs=[numpy.get_include()],
                        define_macros=[(<span style="color: #44BC84;">"NPY_NO_DEPRECATED_API"</span>, <span style="color: #44BC84;">"NPY_1_7_API_VERSION"</span>)],
                        )]

<span style="color: #E83A82;">if</span> USE_CYTHON <span style="color: #E83A82;">or</span> BUILD_C:
    <span style="color: #E83A82;">from</span> Cython.Build <span style="color: #E83A82;">import</span> cythonize
    <span style="color: #FDB760;">extensions</span> = cythonize(extensions, language_level=3, annotate=<span style="color: #8787FF;">True</span>)
<span style="color: #E83A82;">if</span> BUILD_C:
    <span style="color: #8787FF;">exit</span>(0)

<span style="color: #E83A82;">for</span> c <span style="color: #E83A82;">in</span> [<span style="color: #44BC84;">"--cython"</span>, <span style="color: #44BC84;">"--use_cython"</span>, <span style="color: #44BC84;">"-a"</span>, <span style="color: #44BC84;">"--report"</span>, <span style="color: #44BC84;">"build_c"</span>]:
    <span style="color: #E83A82;">if</span> c <span style="color: #E83A82;">in</span> sys.argv:
        sys.argv.remove(c)

setup(ext_modules=extensions)
</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-orgc9cc49f">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="orgc9cc49f">generate-maps.py</h3>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8A8A8A;">#</span><span style="color: #8A8A8A;">!/usr/bin/env python</span>
<span style="color: #E83A82;">import</span> gc
<span style="color: #E83A82;">import</span> datetime
<span style="color: #E83A82;">import</span> numpy <span style="color: #E83A82;">as</span> np
<span style="color: #E83A82;">from</span> pathlib <span style="color: #E83A82;">import</span> Path
<span style="color: #E83A82;">from</span> astropy <span style="color: #E83A82;">import</span> units <span style="color: #E83A82;">as</span> au
<span style="color: #E83A82;">from</span> skais.read <span style="color: #E83A82;">import</span> TNGGalaxy
<span style="color: #E83A82;">from</span> skais.cast <span style="color: #E83A82;">import</span> R
<span style="color: #E83A82;">from</span> skais.raytrace <span style="color: #E83A82;">import</span> voronoi_RT_2D, voronoi_NGP_2D
<span style="color: #E83A82;">from</span> skais.nn.options <span style="color: #E83A82;">import</span> UtilOptions
<span style="color: #E83A82;">from</span> skais.nn.data <span style="color: #E83A82;">import</span> Img2H5Buffer

<span style="color: #E83A82;">import</span> matplotlib.pyplot <span style="color: #E83A82;">as</span> plt
<span style="color: #E83A82;">import</span> matplotlib.ticker <span style="color: #E83A82;">as</span> ticker
<span style="color: #E83A82;">from</span> matplotlib.image <span style="color: #E83A82;">import</span> AxesImage
<span style="color: #E83A82;">from</span> skais.utils.colors <span style="color: #E83A82;">import</span> SKAIsCMaps



<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">get_arrays</span>(obj: TNGGalaxy,
               keys: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">str</span>] = <span style="color: #8787FF;">None</span>,
               factors: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">float</span>] = <span style="color: #8787FF;">None</span>,
               verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>
               ) -&gt; <span style="color: #46D9FF;">list</span>:
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Fetch data (arrays or scalars) from a TNGGalaxy object given keys.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      obj (TNGGalaxy): Instance at a set snapshot, pointing at set subfind ID.</span>
<span style="color: #44BC84;">      keys (list[str]): Keys to fetch data.</span>
<span style="color: #44BC84;">      factors (list[float]): Factors for modifying the fetched data.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>

<span style="color: #44BC84;">    Returns:</span>
<span style="color: #44BC84;">      (list): List of fetched data arrays or scalars.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #E83A82;">if</span> keys <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">keys</span> = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'radii'</span>]
    <span style="color: #E83A82;">if</span> factors <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">factors</span> = [1, 1, 3]
    <span style="color: #FDB760;">vals</span> = []
    <span style="color: #E83A82;">for</span> key, f <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">zip</span>(keys, factors):
        <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(key, (<span style="color: #46D9FF;">tuple</span>, <span style="color: #46D9FF;">list</span>)):
            <span style="color: #E83A82;">try</span>:
                <span style="color: #FDB760;">v1</span> = <span style="color: #46D9FF;">getattr</span>(obj, key[0])
            <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">Exception</span> <span style="color: #E83A82;">as</span> e:
                <span style="color: #FDB760;">v1</span> = obj.subhalo[key[0]]
            <span style="color: #E83A82;">try</span>:
                <span style="color: #FDB760;">v2</span> = <span style="color: #46D9FF;">getattr</span>(obj, key[1])
            <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">Exception</span> <span style="color: #E83A82;">as</span> e:
                <span style="color: #FDB760;">v2</span> = obj.subhalo[key[1]]
            <span style="color: #FDB760;">v</span> = v1 * v2 * f
        <span style="color: #E83A82;">else</span>:
            <span style="color: #E83A82;">try</span>:
                <span style="color: #FDB760;">v</span> = <span style="color: #46D9FF;">getattr</span>(obj, key) * f
            <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">Exception</span> <span style="color: #E83A82;">as</span> e:
                <span style="color: #FDB760;">v</span> = obj.subhalo[key] * f
        vals.append(v)
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Loading arrays: </span>{keys}<span style="color: #44BC84;">..."</span>)
    <span style="color: #E83A82;">return</span> [*vals]


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">indices_within</span>(pos: (np.ndarray | au.Quantity), center: (<span style="color: #46D9FF;">list</span> | np.ndarray | au.Quantity),
                   radius: (<span style="color: #46D9FF;">float</span> | au.Quantity) = <span style="color: #8787FF;">None</span>,
                   fraction: <span style="color: #46D9FF;">float</span> = 0.2,
                   verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>
                   ) -&gt; (au.Quantity, <span style="color: #46D9FF;">list</span>[au.Quantity]):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Get particle indices within a cube of given radius, e.g. half-mass radius.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      pos (np.ndarray): Particle positions to be filtered.</span>
<span style="color: #44BC84;">      center (list | np.ndarray): Center position of the cube.</span>
<span style="color: #44BC84;">      radius (float): Radius, i.e. half-side of the cube.</span>
<span style="color: #44BC84;">      fraction (float): Box fraction for the default radius if not given.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>

<span style="color: #44BC84;">    Returns:</span>
<span style="color: #44BC84;">      ((np.ndarray, list[float]) | (au.Quantity, list[au.Quantity])):</span>
<span style="color: #44BC84;">        Indices of the filtered particle positions and their 3D extent.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #FDB760;">pos_extent</span> = \
        pos[:, 0].<span style="color: #46D9FF;">max</span>() - pos[:, 0].<span style="color: #46D9FF;">min</span>(), \
        pos[:, 1].<span style="color: #46D9FF;">max</span>() - pos[:, 1].<span style="color: #46D9FF;">min</span>(), \
        pos[:, 2].<span style="color: #46D9FF;">max</span>() - pos[:, 2].<span style="color: #46D9FF;">min</span>()
    <span style="color: #FDB760;">w</span> = <span style="color: #46D9FF;">max</span>(pos_extent)
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Box extent:  </span>{pos_extent[0]}<span style="color: #44BC84;">   </span>{pos_extent[1]}<span style="color: #44BC84;">   </span>{pos_extent[2]}<span style="color: #44BC84;">"</span>)
    <span style="color: #E83A82;">if</span> radius <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">radius</span> = 0.5 * fraction * w
    <span style="color: #E83A82;">elif</span> radius &gt; (100 * au.kpc):
        <span style="color: #FDB760;">radius</span> = 100 * au.kpc
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Radius: </span>{radius}<span style="color: #44BC84;">"</span>)
    <span style="color: #FDB760;">xmin</span>, <span style="color: #FDB760;">xmax</span> = center[0]-radius, center[0]+radius
    <span style="color: #FDB760;">ymin</span>, <span style="color: #FDB760;">ymax</span> = center[1]-radius, center[1]+radius
    <span style="color: #FDB760;">zmin</span>, <span style="color: #FDB760;">zmax</span> = center[2]-radius, center[2]+radius
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Extent: </span>{xmax-xmin}<span style="color: #44BC84;">   </span>{ymax-ymin}<span style="color: #44BC84;">   </span>{zmax-zmin}<span style="color: #44BC84;">"</span>)
    <span style="color: #FDB760;">indices</span> = np.where((pos[:, 0] &gt; xmin) &amp; (pos[:, 0] &lt; xmax) &amp;
                       (pos[:, 1] &gt; ymin) &amp; (pos[:, 1] &lt; ymax) &amp;
                       (pos[:, 2] &gt; zmin) &amp; (pos[:, 2] &lt; zmax))[0]
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Selected particles: </span>{indices.shape[0]:,}<span style="color: #44BC84;"> / </span>{pos.shape[0]:,}<span style="color: #44BC84;">"</span>)
    <span style="color: #E83A82;">return</span> indices, [xmin, ymin, zmin, xmax, ymax, zmax]


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">strip_units</span>(*args: <span style="color: #46D9FF;">tuple</span>[au.Quantity],
                mask: <span style="color: #46D9FF;">list</span> = <span style="color: #8787FF;">None</span>,
                units: <span style="color: #46D9FF;">list</span>[au.Unit] = <span style="color: #8787FF;">None</span>,
                dtype: np.dtype = np.float32
                ) -&gt; <span style="color: #46D9FF;">tuple</span>[np.ndarray]:
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Remove astropy units from data arrays or scalars.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      args (tuple[au.Quantity]): Data arrays or scalars with astropy units.</span>
<span style="color: #44BC84;">      mask (np.ndarray): Mask for the data arrays.</span>
<span style="color: #44BC84;">      units (au.Unit): Astropy units to be stripped.</span>
<span style="color: #44BC84;">      dtype (np.dtype): Data type of the stripped data array.</span>

<span style="color: #44BC84;">    Returns:</span>
<span style="color: #44BC84;">      (tuple[np.ndarray]): Of astropy units stripped data arrays or scalars.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #FDB760;">args</span> = <span style="color: #46D9FF;">list</span>(args)
    <span style="color: #E83A82;">for</span> i, arg <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">enumerate</span>(args):
        <span style="color: #E83A82;">if</span> units <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #E83A82;">for</span> u <span style="color: #E83A82;">in</span> units:
                <span style="color: #E83A82;">if</span> args[i].unit.is_equivalent(u):
                    <span style="color: #FDB760;">args</span>[i] = args[i].to(u)
        <span style="color: #FDB760;">args</span>[i] = args[i].value
        <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(args[i], np.ndarray):
            <span style="color: #E83A82;">if</span> mask <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
                <span style="color: #FDB760;">args</span>[i] = args[i][mask].astype(dtype)
    <span style="color: #E83A82;">return</span> args


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">generate_map</span>(obj: TNGGalaxy,
                 keys: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">str</span>] = <span style="color: #8787FF;">None</span>,
                 factors: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">float</span>] = <span style="color: #8787FF;">None</span>,
                 use_half_mass_rad: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
                 fh: <span style="color: #46D9FF;">float</span> = 3,
                 grid_size: <span style="color: #46D9FF;">int</span> = 512,
                 xaxis: <span style="color: #46D9FF;">int</span> = 0, yaxis: <span style="color: #46D9FF;">int</span> = 1,
                 periodic: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
                 assignment_func: <span style="color: #46D9FF;">callable</span> = voronoi_RT_2D,
                 tracers: <span style="color: #46D9FF;">int</span> = <span style="color: #8787FF;">None</span>, divisions: <span style="color: #46D9FF;">int</span> = <span style="color: #8787FF;">None</span>,
                 rot: (<span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">int</span>, <span style="color: #46D9FF;">int</span>] | <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">float</span>, <span style="color: #46D9FF;">float</span>]) = <span style="color: #8787FF;">None</span>,
                 verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>
                 ) -&gt; (np.ndarray, np.ndarray, <span style="color: #46D9FF;">int</span>):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Generate raytracing projection map.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      obj (TNGGalaxy): Instance at a set snapshot, pointing at set subfind ID.</span>
<span style="color: #44BC84;">      keys (list[str]): Keys to fetch data for projecting onto the map.</span>
<span style="color: #44BC84;">      factors (list[float]): Factors for modifying the projection data.</span>
<span style="color: #44BC84;">      use_half_mass_rad (bool):</span>
<span style="color: #44BC84;">        If True, the SubhaloHalfmassRad from the subfind catalog is used for</span>
<span style="color: #44BC84;">        selecting relevant particles. Otherwise, a fraction of the entire</span>
<span style="color: #44BC84;">        particle extent is used.</span>
<span style="color: #44BC84;">      fh (int | float): Expansion factor for the SPH particle radii.</span>
<span style="color: #44BC84;">      grid_size (int): The size of the maps/images. Default: 512.</span>
<span style="color: #44BC84;">      xaxis (int): Projection axis for x.</span>
<span style="color: #44BC84;">      yaxis (int): Projection axis for y.</span>
<span style="color: #44BC84;">      periodic (bool): Use periodic boundary conditions for the projection.</span>
<span style="color: #44BC84;">      assignment_func (callable): Mass assignment algorithm.</span>
<span style="color: #44BC84;">                                  Default: voronoi_RT_2D.</span>
<span style="color: #44BC84;">      tracers (int):</span>
<span style="color: #44BC84;">        Number of tracer particles to use for the Nearest Grid Point algorithm.</span>
<span style="color: #44BC84;">      divisions (int):</span>
<span style="color: #44BC84;">        Number of sphere divisions to use for the Nearest Grid Point algorithm.</span>
<span style="color: #44BC84;">      rot (list[int, int] | list[float, float]):</span>
<span style="color: #44BC84;">        Angles to rotate the particle positions.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>

<span style="color: #44BC84;">    Returns:</span>
<span style="color: #44BC84;">      (np.ndarray, np.ndarray, int):</span>
<span style="color: #44BC84;">        The projected map, the map extent, and number of particles projected.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #FDB760;">L</span>, <span style="color: #FDB760;">M</span>, <span style="color: #FDB760;">T</span> = au.Mpc, au.Msun, au.K
    <span style="color: #FDB760;">cd</span> = np.zeros((grid_size, grid_size), dtype=np.float64)
    <span style="color: #E83A82;">if</span> keys <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">keys</span> = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
    <span style="color: #E83A82;">if</span> factors <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">factors</span> = [1, 1, fh, 1]
    <span style="color: #E83A82;">if</span> use_half_mass_rad:
        <span style="color: #E83A82;">if</span> <span style="color: #44BC84;">'SubhaloHalfmassRadType'</span> <span style="color: #E83A82;">not</span> <span style="color: #E83A82;">in</span> keys:
            <span style="color: #FDB760;">keys</span> += [<span style="color: #44BC84;">'SubhaloHalfmassRadType'</span>]
            <span style="color: #FDB760;">factors</span> += [obj.units(<span style="color: #44BC84;">'l/h'</span>)]
        <span style="color: #E83A82;">else</span>:
            factors.insert(keys.index(<span style="color: #44BC84;">'SubhaloHalfmassRadType'</span>), obj.units(<span style="color: #44BC84;">'l/h'</span>))
    <span style="color: #FDB760;">uarrs</span> = get_arrays(obj, keys=keys, factors=factors, verbose=verbose)
    <span style="color: #E83A82;">if</span> rot <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">rot_op</span> = R.y(rot[1])*R.x(rot[0])
        <span style="color: #FDB760;">uarrs</span>[0] = rot_op(uarrs[0]).astype(np.float32)
        <span style="color: #FDB760;">uarrs</span>[3] = rot_op(uarrs[3]).astype(np.float32)
    <span style="color: #FDB760;">Ngids</span> = uarrs[0].shape[0]
    <span style="color: #FDB760;">hmr</span> = (uarrs[4][0] <span style="color: #E83A82;">if</span> use_half_mass_rad <span style="color: #E83A82;">else</span> <span style="color: #8787FF;">None</span>)  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">always use gas (p_idx=0) hmr</span>
    <span style="color: #8A8A8A;">#</span><span style="color: #8A8A8A;">hmr = (uarrs[4][obj.p_idx] if use_half_mass_rad else None)</span>
    <span style="color: #FDB760;">idcs</span>, <span style="color: #FDB760;">limits</span> = indices_within(uarrs[0], uarrs[3], radius=hmr, verbose=verbose)
    <span style="color: #FDB760;">hmr2</span> = limits[3] - limits[0]
    <span style="color: #FDB760;">args</span> = strip_units(*uarrs[:3], *limits[:2], hmr2, mask=idcs, units=[L, M, T*M])
    <span style="color: #E83A82;">if</span> tracers <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
        args.append(tracers)
    <span style="color: #E83A82;">else</span>:
        args.append(xaxis)
    <span style="color: #E83A82;">if</span> divisions <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
        args.append(divisions)
    <span style="color: #E83A82;">else</span>:
        args.append(yaxis)
    <span style="color: #E83A82;">if</span> verbose:
        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Raytracing particles with &lt;</span>{assignment_func.<span style="color: #46D9FF;">__name__</span>}<span style="color: #44BC84;">&gt;..."</span>)
    <span style="color: #E83A82;">try</span>:
        assignment_func(cd, *args, periodic, verbose=<span style="color: #8787FF;">True</span>)
    <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">Exception</span> <span style="color: #E83A82;">as</span> e:
        <span style="color: #46D9FF;">print</span>(e)
        <span style="color: #E83A82;">return</span> cd * uarrs[1].unit / L**2
    <span style="color: #FDB760;">cd</span> = cd * uarrs[1].unit / L**2
    <span style="color: #E83A82;">return</span> cd, hmr2/2*np.array([-1, 1, -1, 1]), idcs.shape[0]


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">plot_map</span>(cdmap: (np.ndarray | au.Quantity), extent: (np.ndarray | au.Quantity),
             group: <span style="color: #46D9FF;">str</span> = <span style="color: #44BC84;">'gas'</span>,
             cmap: Colormap = SKAIsCMaps.gaseous,
             interpolation: <span style="color: #46D9FF;">str</span> = <span style="color: #44BC84;">'bicubic'</span>,
             origin: <span style="color: #46D9FF;">str</span> = <span style="color: #44BC84;">'lower'</span>,
             out_path: (<span style="color: #46D9FF;">str</span> | Path) = <span style="color: #8787FF;">None</span>,
             basename: <span style="color: #46D9FF;">str</span> = <span style="color: #8787FF;">None</span>,
             cbar_label: <span style="color: #46D9FF;">str</span> = <span style="color: #8787FF;">None</span>,
             no_log: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>,
             label: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
             colorbar: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
             savefig: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>,
             show: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
             close: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
             verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>
             ) -&gt; AxesImage:
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Plot the map data with specific defaults suitable for projected maps</span>
<span style="color: #44BC84;">    from IllustrisTNG.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      cdmap (np.ndarray | au.Quantity): Image map data.</span>
<span style="color: #44BC84;">      extent (np.ndarray | au.Quantity): Image map extent.</span>
<span style="color: #44BC84;">      group (str): Galaxy property of the map, e.g. star, gas, or dm.</span>
<span style="color: #44BC84;">      cmap (Colormap): Colormap for map plot.</span>
<span style="color: #44BC84;">      interpolation (str): Alternative default for matplotlib.pyplot.imshow.</span>
<span style="color: #44BC84;">      origin (str): Alternative default for matplotlib.pyplot.imshow.</span>
<span style="color: #44BC84;">      out_path (str | Path): The root in which the plot is saved.</span>
<span style="color: #44BC84;">      basename (str): Basname of the file to which the plot is written.</span>
<span style="color: #44BC84;">      cbar_label (str): The colorbar label. Default: r"log $\Sigma$"</span>
<span style="color: #44BC84;">      no_log (bool): If True, plot the data in linear scale.</span>
<span style="color: #44BC84;">      label (bool): If True, include the x and y axis labels in the plot.</span>
<span style="color: #44BC84;">      colorbar (bool): If True, include the colorbar in the plot.</span>
<span style="color: #44BC84;">      savefig (bool): If True, save the plot to file.</span>
<span style="color: #44BC84;">      show (bool): If True, show the plot.</span>
<span style="color: #44BC84;">      close (bool): If True, close the figure after execution.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>

<span style="color: #44BC84;">    Returns:</span>
<span style="color: #44BC84;">      (matplotlib.image.AxesImage): Matplotlib image instance.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">hasattr</span>(cdmap, <span style="color: #44BC84;">'value'</span>):
        <span style="color: #FDB760;">cd</span> = cdmap.value
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">cd</span> = cdmap
    <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">hasattr</span>(extent, <span style="color: #44BC84;">'value'</span>):
        <span style="color: #FDB760;">ext</span> = extent.value
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">ext</span> = extent
    <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">hasattr</span>(cdmap, <span style="color: #44BC84;">'unit'</span>) <span style="color: #E83A82;">and</span> cdmap.unit:
        <span style="color: #FDB760;">ucd</span> = f<span style="color: #44BC84;">"[</span>{cdmap.unit}<span style="color: #44BC84;">]"</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">ucd</span> = <span style="color: #44BC84;">""</span>
    <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">hasattr</span>(extent, <span style="color: #44BC84;">'unit'</span>) <span style="color: #E83A82;">and</span> extent.unit:
        <span style="color: #FDB760;">uext</span> = f<span style="color: #44BC84;">"[</span>{extent.unit}<span style="color: #44BC84;">]"</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">uext</span> = <span style="color: #44BC84;">""</span>
    <span style="color: #FDB760;">fig</span> = plt.figure(dpi=100)
    <span style="color: #E83A82;">if</span> no_log:
        <span style="color: #FDB760;">img</span> = plt.imshow(cd, cmap=cmap, extent=ext,
                         interpolation=interpolation, origin=origin)
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">img</span> = plt.imshow(np.log10(cd), cmap=cmap, extent=ext,
                         interpolation=interpolation, origin=origin)
    <span style="color: #E83A82;">if</span> label:
        plt.xlabel(f<span style="color: #44BC84;">"x </span>{uext}<span style="color: #44BC84;">"</span>)
        plt.ylabel(f<span style="color: #44BC84;">"y </span>{uext}<span style="color: #44BC84;">"</span>)
    <span style="color: #E83A82;">if</span> colorbar:
        <span style="color: #FDB760;">lbl</span> = cbar_label
        <span style="color: #E83A82;">if</span> cbar_label <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">lbl</span> = <span style="color: #44BC84;">"log "</span>+u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u03A3</span><span style="color: #44BC84;"> "</span>+ucd
        <span style="color: #E83A82;">if</span> <span style="color: #44BC84;">"["</span> <span style="color: #E83A82;">not</span> <span style="color: #E83A82;">in</span> lbl <span style="color: #E83A82;">or</span> <span style="color: #44BC84;">"]"</span> <span style="color: #E83A82;">not</span> <span style="color: #E83A82;">in</span> lbl:
            <span style="color: #FDB760;">lbl</span> = cbar_label + ucd
        <span style="color: #FDB760;">lbl</span> = lbl.replace(<span style="color: #44BC84;">"solMass"</span>, <span style="color: #44BC84;">"M"</span>+r<span style="color: #44BC84;">"$_{\odot}$"</span>).replace(<span style="color: #44BC84;">"2"</span>, u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u00B2</span><span style="color: #44BC84;">"</span>)
        <span style="color: #FDB760;">eformat</span> = ticker.ScalarFormatter()
        eformat.set_powerlimits((-2, 2))
        <span style="color: #FDB760;">cbar</span> = plt.colorbar(label=lbl, <span style="color: #46D9FF;">format</span>=eformat)
    <span style="color: #E83A82;">if</span> savefig:
        <span style="color: #E83A82;">if</span> basename <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">basename</span> = <span style="color: #44BC84;">'gas_image'</span>
        <span style="color: #E83A82;">if</span> out_path <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">out_path</span> = Path(<span style="color: #44BC84;">'./data'</span>)
        <span style="color: #E83A82;">elif</span> <span style="color: #E83A82;">not</span> <span style="color: #46D9FF;">isinstance</span>(out_path, Path):
            <span style="color: #FDB760;">out_path</span> = Path(out_path)
        <span style="color: #FDB760;">filename</span> = out_path / group / (basename + <span style="color: #44BC84;">'.png'</span>)
        plt.savefig(filename, transparent=<span style="color: #8787FF;">True</span>, bbox_inches=<span style="color: #44BC84;">'tight'</span>)
        <span style="color: #E83A82;">if</span> verbose:
            <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Saving to [png]: </span>{filename}<span style="color: #44BC84;">"</span>)
    <span style="color: #E83A82;">if</span> show:
        plt.show()
    <span style="color: #E83A82;">if</span> close:
        plt.close()
    <span style="color: #E83A82;">return</span> img


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">run_sample</span>(obj: TNGGalaxy, gid: <span style="color: #46D9FF;">int</span>,
               group: <span style="color: #46D9FF;">str</span> = <span style="color: #44BC84;">'gas'</span>,
               cdunit: au.Unit = <span style="color: #8787FF;">None</span>,
               cmap: Colormap = <span style="color: #8787FF;">None</span>,
               out_path: (<span style="color: #46D9FF;">str</span> | Path) = <span style="color: #8787FF;">None</span>,
               hdf5_save: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
               hdf5_name: (<span style="color: #46D9FF;">str</span> | Path) = <span style="color: #8787FF;">None</span>,
               npy_save: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>,
               opt: UtilOptions = <span style="color: #8787FF;">None</span>,
               grid_size: <span style="color: #46D9FF;">int</span> = 512,
               fh: <span style="color: #46D9FF;">float</span> = 3,
               rot: (<span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">float</span>, <span style="color: #46D9FF;">float</span>] | np.ndarray[<span style="color: #46D9FF;">float</span>, <span style="color: #46D9FF;">float</span>]) = <span style="color: #8787FF;">None</span>,
               xaxis: <span style="color: #46D9FF;">int</span> = 0,
               yaxis: <span style="color: #46D9FF;">int</span> = 1,
               periodic: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>,
               rng_seed: <span style="color: #46D9FF;">int</span> = 42,
               flag_lim: <span style="color: #46D9FF;">float</span> = 0,
               flag_N: <span style="color: #46D9FF;">int</span> = 64,
               verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Project a subfind ID from an IllstrisTNG snapshot.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      obj (TNGGalaxy): Instance at a set snapshot, pointing at set subfind ID.</span>
<span style="color: #44BC84;">      group (str): Galaxy property of the map, e.g. star, gas, or dm.</span>
<span style="color: #44BC84;">      cdunit (au.Unit): Units in which the map is to be projected.</span>
<span style="color: #44BC84;">      cmap (Colormap): Colormap for map plot.</span>
<span style="color: #44BC84;">      out_path (str | Path): The root in which the plot is saved.</span>
<span style="color: #44BC84;">      hdf5_save (bool): If True, save map to HDF5 file.</span>
<span style="color: #44BC84;">      hdf5_name (str | Path): Basename of the HDF5 file.</span>
<span style="color: #44BC84;">      npy_save (bool): If True, save map as numpy binary files.</span>
<span style="color: #44BC84;">      opt (UtilOptions): Utility options containing further configurations.</span>
<span style="color: #44BC84;">      grid_size (int): The size of the maps/images. Default: 512.</span>
<span style="color: #44BC84;">      fh (int | float): Expansion factor for the SPH particle radii.</span>
<span style="color: #44BC84;">      rot (list[int, int] | list[float, float]):</span>
<span style="color: #44BC84;">        Angles to rotate the particle positions.</span>
<span style="color: #44BC84;">      xaxis (int): Projection axis for x.</span>
<span style="color: #44BC84;">      yaxis (int): Projection axis for y.</span>
<span style="color: #44BC84;">      periodic (bool): Use periodic boundary conditions for the projection.</span>
<span style="color: #44BC84;">      rng_seed (int): Seed for the random number generation.</span>
<span style="color: #44BC84;">      flag_lim (float):</span>
<span style="color: #44BC84;">        Flag the map in the metadata if N pixel values fall below the limit.</span>
<span style="color: #44BC84;">      flag_N (int):</span>
<span style="color: #44BC84;">        The number of pixels before an image is flagged.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #E83A82;">if</span> out_path <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">out_path</span> = Path(<span style="color: #44BC84;">'./data'</span>)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">load data</span>
    <span style="color: #E83A82;">if</span> gid != obj.halo_index:
        obj.<span style="color: #FDB760;">halo_index</span> = gid
    <span style="color: #FDB760;">kwargs</span> = {<span style="color: #44BC84;">'use_half_mass_rad'</span>: <span style="color: #8787FF;">True</span>, <span style="color: #44BC84;">'fh'</span>: fh, <span style="color: #44BC84;">'grid_size'</span>: grid_size,
              <span style="color: #44BC84;">'xaxis'</span>: xaxis, <span style="color: #44BC84;">'yaxis'</span>: yaxis, <span style="color: #44BC84;">'periodic'</span>: periodic, <span style="color: #44BC84;">'rot'</span>: rot,
              <span style="color: #44BC84;">'verbose'</span>: verbose}
    <span style="color: #FDB760;">no_log</span> = <span style="color: #8787FF;">False</span>
    <span style="color: #FDB760;">post_hook</span> = <span style="color: #8787FF;">None</span>
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">set up configs for group</span>
    <span style="color: #E83A82;">if</span> group == <span style="color: #44BC84;">'gas'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.Msun/au.kpc**2
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.gaseous
        <span style="color: #FDB760;">cbar_label</span> = <span style="color: #44BC84;">"log "</span>+u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u03A3</span><span style="color: #44BC84;">"</span>+r<span style="color: #44BC84;">"$_{\mathrm{gas}}$ "</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'hi'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'m_HI'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.Msun/au.kpc**2
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.gaseous
        <span style="color: #FDB760;">cbar_label</span> = <span style="color: #44BC84;">"log "</span>+u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u03A3</span><span style="color: #44BC84;">"</span>+<span style="color: #44BC84;">"$_{\mathrm{HI}}$ "</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'hi/21cm'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'m_HI'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'assignment_func'</span>] = voronoi_NGP_2D
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'tracers'</span>] = 128
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'divisions'</span>] = 2
        <span style="color: #FDB760;">pixel_size</span> = 1. / grid_size
        <span style="color: #FDB760;">z</span>, <span style="color: #FDB760;">h</span>, <span style="color: #FDB760;">H0</span>, <span style="color: #FDB760;">Hz</span> = obj.cosmology.z, obj.cosmology.h, obj.cosmology.H0, obj.cosmology.H(obj.cosmology.a)
        <span style="color: #FDB760;">sigma_crit</span> = obj.cosmology.rho_crit
        <span style="color: #FDB760;">post_hook</span> = <span style="color: #E83A82;">lambda</span> x, y: (189 * au.mK * h * (1+z)**2 * (H0/Hz) * x/((y[1]-y[0])*pixel_size*sigma_crit))
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.mK
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.nava
        <span style="color: #FDB760;">cbar_label</span>=r<span style="color: #44BC84;">"T$_{\mathrm{b}}$ "</span>
        <span style="color: #FDB760;">flag_lim</span>, <span style="color: #FDB760;">flag_N</span> = 0, grid_size**2/10
        <span style="color: #FDB760;">no_log</span> = <span style="color: #8787FF;">True</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'temp'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, (<span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'temperature'</span>), <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.K
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.phoenix
        <span style="color: #FDB760;">cbar_label</span>=<span style="color: #44BC84;">"log T "</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'bfield'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, (<span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'magnetic_field_strength'</span>), <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.Gauss
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.gravic
        <span style="color: #FDB760;">cbar_label</span>=<span style="color: #44BC84;">"log |B| "</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'star'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.Msun/au.kpc**2
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.hertzsprung
        <span style="color: #FDB760;">cbar_label</span> = <span style="color: #44BC84;">"log "</span>+u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u03A3</span><span style="color: #44BC84;">"</span>+r<span style="color: #44BC84;">"$_{\mathrm{star}}$ "</span>
    <span style="color: #E83A82;">elif</span> group == <span style="color: #44BC84;">'dm'</span>:
        <span style="color: #FDB760;">kwargs</span>[<span style="color: #44BC84;">'keys'</span>] = [<span style="color: #44BC84;">'particle_positions'</span>, <span style="color: #44BC84;">'masses'</span>, <span style="color: #44BC84;">'radii'</span>, <span style="color: #44BC84;">'center'</span>]
        <span style="color: #E83A82;">if</span> cdunit <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cdunit = au.Msun/au.kpc**2
        <span style="color: #E83A82;">if</span> cmap <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>: cmap = SKAIsCMaps.obscura
        <span style="color: #FDB760;">cbar_label</span> = <span style="color: #44BC84;">"log "</span>+u<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\u03A3</span><span style="color: #44BC84;">"</span>+r<span style="color: #44BC84;">"$_{\mathrm{dm}}$ "</span>
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">allocate arrays and raytrace</span>
    <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(kwargs[<span style="color: #44BC84;">'keys'</span>][1], (<span style="color: #46D9FF;">tuple</span>, <span style="color: #46D9FF;">list</span>)):
        <span style="color: #FDB760;">keys</span> = kwargs.pop(<span style="color: #44BC84;">'keys'</span>)
        <span style="color: #FDB760;">cd1</span>, <span style="color: #FDB760;">extent</span>, <span style="color: #FDB760;">N</span> = generate_map(obj, keys=keys, **kwargs)
        <span style="color: #FDB760;">keys</span>[1] = keys[1][0]
        <span style="color: #FDB760;">cd0</span>, <span style="color: #FDB760;">_</span>, <span style="color: #FDB760;">_</span> = generate_map(obj, keys=keys, **kwargs)
        <span style="color: #FDB760;">cd</span> = np.zeros_like(cd1.value)
        np.place(cd, cd0.value != 0, cd1.value[cd0.value != 0]/cd0.value[cd0.value != 0])
        <span style="color: #FDB760;">cd</span> *= (cd1.unit / cd0.unit)
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">cd</span>, <span style="color: #FDB760;">extent</span>, <span style="color: #FDB760;">N</span> = generate_map(obj, **kwargs)
    <span style="color: #E83A82;">if</span> post_hook <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">cd</span> = post_hook(cd, extent)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">convert to chosen units</span>
    <span style="color: #FDB760;">cd</span> = cd.to(cdunit)
    <span style="color: #FDB760;">cbar_label</span> += f<span style="color: #44BC84;">"[</span>{cd.unit}<span style="color: #44BC84;">]"</span>
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">check for potential problems</span>
    <span style="color: #FDB760;">flag</span> = 0
    <span style="color: #E83A82;">if</span> np.<span style="color: #46D9FF;">sum</span>(cd.value &lt; flag_lim) &gt; flag_N:
        <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"Bad projection, flagging image..."</span>)
        <span style="color: #FDB760;">flag</span> = 1
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">plot data</span>
    <span style="color: #FDB760;">rot_str</span> = f<span style="color: #44BC84;">"_rotxy.</span>{rot[0]}<span style="color: #44BC84;">.</span>{rot[1]}<span style="color: #44BC84;">"</span> <span style="color: #E83A82;">if</span> rot <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> <span style="color: #44BC84;">""</span>
    <span style="color: #FDB760;">bname</span> = f<span style="color: #44BC84;">"</span>{<span style="color: #46D9FF;">str</span>(Path(group).stem)}<span style="color: #44BC84;">_tng50-1.</span>{obj.snapshot:02d}<span style="color: #44BC84;">.gid.</span>{obj.halo_index:07d}{rot_str}<span style="color: #44BC84;">"</span>
    plot_map(cd, extent, group=group, out_path=out_path, basename=bname,
             cbar_label=cbar_label, cmap=cmap,
             no_log=no_log, savefig=<span style="color: #8787FF;">True</span>, show=<span style="color: #8787FF;">False</span>, verbose=verbose)
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">save data</span>
    <span style="color: #E83A82;">if</span> npy_save:
        <span style="color: #FDB760;">npname</span> = f<span style="color: #44BC84;">"</span>{bname}<span style="color: #44BC84;">_units.</span>{cd.unit}<span style="color: #44BC84;">_extent.</span>{extent[1]-extent[0]:4.8f}<span style="color: #44BC84;">.npy"</span>.replace(<span style="color: #44BC84;">' '</span>, <span style="color: #44BC84;">''</span>).replace(<span style="color: #44BC84;">'/'</span>, <span style="color: #44BC84;">'_'</span>)
        np.save(npname, cd)
        <span style="color: #E83A82;">if</span> verbose:
            <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Saving to [npy]: </span>{npname}<span style="color: #44BC84;">"</span>)
    <span style="color: #E83A82;">if</span> hdf5_save <span style="color: #E83A82;">and</span> hdf5_name <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">opt</span> = UtilOptions() <span style="color: #E83A82;">if</span> opt <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> opt
        <span style="color: #FDB760;">img2h5</span> = Img2H5Buffer(opt, find=<span style="color: #8787FF;">False</span>)
        <span style="color: #FDB760;">md</span> = {<span style="color: #44BC84;">'simulation'</span>: <span style="color: #44BC84;">'IllustrisTNG'</span>, <span style="color: #44BC84;">'box'</span>: <span style="color: #44BC84;">'tng50-1'</span>, <span style="color: #44BC84;">'class'</span>: group,
              <span style="color: #44BC84;">'gid'</span>: obj.halo_index, <span style="color: #44BC84;">'snapshot'</span>: obj.snapshot,
              <span style="color: #44BC84;">'units'</span>: f<span style="color: #44BC84;">"</span>{cd.unit}<span style="color: #44BC84;">"</span>,
              <span style="color: #44BC84;">'extent'</span>: extent.value, <span style="color: #44BC84;">'units_extent'</span>: f<span style="color: #44BC84;">"</span>{extent.unit}<span style="color: #44BC84;">"</span>,
              <span style="color: #44BC84;">'name'</span>: bname, <span style="color: #44BC84;">'num_particles'</span>: N,
              <span style="color: #44BC84;">'rotxy'</span>: rot <span style="color: #E83A82;">if</span> rot <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> (0, 0),
              <span style="color: #44BC84;">'flagged'</span>: flag, <span style="color: #44BC84;">'rng_seed'</span>: rng_seed}
        img2h5.inc_write(hdf5_name, cd.value, group, metadata=md)
        <span style="color: #E83A82;">if</span> verbose:
            <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Saving to [hdf5]: </span>{hdf5_name}<span style="color: #44BC84;">"</span>)


<span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">main</span>(tng_ids: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">int</span>], gids: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">int</span>],
         groups: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">str</span>] = <span style="color: #8787FF;">None</span>,
         sim_path: (<span style="color: #46D9FF;">str</span> | Path) = <span style="color: #44BC84;">'./simulations'</span>,
         tng_sim: <span style="color: #46D9FF;">str</span> = <span style="color: #44BC84;">'tng50-1'</span>,
         hdf5_file: <span style="color: #46D9FF;">str</span> = <span style="color: #8787FF;">None</span>,
         opt: UtilOptions = <span style="color: #8787FF;">None</span>,
         grid_size: <span style="color: #46D9FF;">int</span> = 512,
         rotations: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">int</span>, <span style="color: #46D9FF;">int</span>]] = <span style="color: #8787FF;">None</span>,
         random_rotations: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>,
         rng_seed: <span style="color: #46D9FF;">int</span> = 42,
         verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">True</span>):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Generate an arbitrary number of maps from an IllustrisTNG snapshot.</span>

<span style="color: #44BC84;">    Args:</span>
<span style="color: #44BC84;">      tng_ids (list[int]): Snapshots number of the IllustrisTNG run.</span>
<span style="color: #44BC84;">      gids (list[int]): Subfind IDs, i.e. galaxies, from which to generate maps.</span>
<span style="color: #44BC84;">      groups: (list[str]): Galaxy properties to map, e.g. star, gas, or dm.</span>
<span style="color: #44BC84;">      sim_path (str | Path): Path to the root of the simulation snapshots.</span>
<span style="color: #44BC84;">                             Default: ./simulations.</span>
<span style="color: #44BC84;">      tng_sim (str): Simulation box name specification. Default: tng50-1.</span>
<span style="color: #44BC84;">      hdf5_file (str):</span>
<span style="color: #44BC84;">        HDF5 filename to which the maps are written. If None and the config</span>
<span style="color: #44BC84;">        source parameter is also None, saving to HDF5 is disabled.</span>
<span style="color: #44BC84;">      opt (Options): Options gathered from command-line and config files.</span>
<span style="color: #44BC84;">      grid_size (int): The size of the maps/images. Default: 512.</span>
<span style="color: #44BC84;">      rotations (list[list[int, int]]):</span>
<span style="color: #44BC84;">        List of angle pairs (theta, phi) per rotation for each subfind ID; e.g.</span>
<span style="color: #44BC84;">        for 4 separate rotations per subfind ID, its shape is (len(gids), 4, 2).</span>
<span style="color: #44BC84;">      random_rotations (bool):</span>
<span style="color: #44BC84;">        If True, use random rotations (2 per subfind ID) to augment the dataset.</span>
<span style="color: #44BC84;">      verbose (bool): If True, print status updates to command line.</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #FDB760;">opt</span> = UtilOptions() <span style="color: #E83A82;">if</span> opt <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> opt
    <span style="color: #FDB760;">tng_ids</span> = <span style="color: #46D9FF;">list</span>(tng_ids)
    <span style="color: #FDB760;">gids</span> = <span style="color: #46D9FF;">list</span>(gids)
    <span style="color: #FDB760;">Ng</span> = <span style="color: #46D9FF;">len</span>(gids)
    <span style="color: #FDB760;">generate_stars</span> =  <span style="color: #44BC84;">"star"</span> <span style="color: #E83A82;">in</span> groups <span style="color: #E83A82;">if</span> groups <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> <span style="color: #8787FF;">False</span>
    <span style="color: #FDB760;">generate_dm</span> = <span style="color: #44BC84;">"dm"</span> <span style="color: #E83A82;">in</span> groups <span style="color: #E83A82;">if</span> groups <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> <span style="color: #8787FF;">False</span>
    <span style="color: #E83A82;">if</span> groups <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">groups</span> = [<span style="color: #44BC84;">"gas"</span>, <span style="color: #44BC84;">"hi"</span>, <span style="color: #44BC84;">"hi/21cm"</span>, <span style="color: #44BC84;">"temp"</span>, <span style="color: #44BC84;">"bfield"</span>, <span style="color: #44BC84;">"star"</span>, <span style="color: #44BC84;">"dm"</span>]
    <span style="color: #E83A82;">if</span> <span style="color: #44BC84;">"star"</span> <span style="color: #E83A82;">in</span> groups:
        groups.remove(<span style="color: #44BC84;">"star"</span>)
        <span style="color: #FDB760;">generate_stars</span> = <span style="color: #8787FF;">True</span>
    <span style="color: #E83A82;">if</span> <span style="color: #44BC84;">"dm"</span> <span style="color: #E83A82;">in</span> groups:
        groups.remove(<span style="color: #44BC84;">"dm"</span>)
        <span style="color: #FDB760;">generate_dm</span> = <span style="color: #8787FF;">True</span>
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">gather paths</span>
    <span style="color: #FDB760;">sim_path</span> = Path(sim_path)
    <span style="color: #FDB760;">tng_path</span> = sim_path / tng_sim
    <span style="color: #FDB760;">data_path</span> = Path(opt.data_dir)
    <span style="color: #FDB760;">hdf5_save</span> = <span style="color: #8787FF;">True</span>
    <span style="color: #E83A82;">if</span> hdf5_file <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #E83A82;">if</span> opt.output <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">and</span> Path(opt.output).exists():
            <span style="color: #FDB760;">hdf5_file</span> = opt.output
        <span style="color: #E83A82;">elif</span> opt.output <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">hdf5_file</span> = <span style="color: #46D9FF;">str</span>(Path(opt.data_dir) / opt.output)
        <span style="color: #E83A82;">elif</span> opt.source <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">and</span> Path(opt.source).exists():
            <span style="color: #FDB760;">hdf5_file</span> = opt.source
        <span style="color: #E83A82;">elif</span> opt.source <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">hdf5_file</span> = <span style="color: #46D9FF;">str</span>(Path(opt.data_dir) / opt.source)
        <span style="color: #E83A82;">else</span>:
            <span style="color: #FDB760;">hdf5_save</span> = <span style="color: #8787FF;">False</span>

    <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"Resolved paths:"</span>)
    <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"simulations:"</span>, sim_path.resolve())
    <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"data:       "</span>, data_path.resolve())
    <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"tng50-1:    "</span>, tng_path.resolve())
    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">verify existance</span>
    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"</span>{sim_path.resolve()}<span style="color: #44BC84;">: exists"</span>, sim_path.exists())
    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"</span>{tng_path.resolve()}<span style="color: #44BC84;">: exists"</span>, tng_path.exists())

    <span style="color: #E83A82;">if</span> random_rotations:
        <span style="color: #FDB760;">rotations</span> = np.stack((np.random.randint(25, 180, size=Ng),
                              np.random.randint(25, 90, size=Ng)))
        <span style="color: #FDB760;">rotations</span> = np.vstack((rotations,
                               rotations[0]+np.random.randint(20, 40, size=Ng),
                               rotations[1]+np.random.randint(70, 110, size=Ng))
                              ).T.reshape(Ng, 2, 2)
    <span style="color: #E83A82;">for</span> tng_id <span style="color: #E83A82;">in</span> tng_ids:
        <span style="color: #FDB760;">h5fp</span> = f<span style="color: #44BC84;">"Snapshot_</span>{tng_id:d}<span style="color: #44BC84;">"</span>
        <span style="color: #FDB760;">out_path</span> = data_path / f<span style="color: #44BC84;">"</span>{tng_id:03d}<span style="color: #44BC84;">"</span>
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">create directories if necessary</span>
        <span style="color: #E83A82;">for</span> key <span style="color: #E83A82;">in</span> groups:
            <span style="color: #FDB760;">d</span> = out_path / key
            <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">not</span> d.exists():
                d.mkdir(parents=<span style="color: #8787FF;">True</span>)
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"mkdir -p </span>{d.resolve()}<span style="color: #44BC84;">"</span>)
        <span style="color: #FDB760;">tng_src</span> = TNGGalaxy(tng_path, tng_id, halo_index=gids[0], as_float32=<span style="color: #8787FF;">True</span>)
        <span style="color: #E83A82;">for</span> i, gid <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">enumerate</span>(gids):
            <span style="color: #FDB760;">angles</span> = [] <span style="color: #E83A82;">if</span> rotations <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> rotations[i]
            <span style="color: #E83A82;">for</span> group <span style="color: #E83A82;">in</span> groups:
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;"># Snapshot </span>{tng_id}<span style="color: #44BC84;">, subhalo </span>{gid}<span style="color: #44BC84;">, </span>{group}<span style="color: #44BC84;">"</span>)
                run_sample(tng_src, gid, group=group,
                           out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                           grid_size=grid_size, fh=1, rng_seed=rng_seed, rot=<span style="color: #8787FF;">None</span>)
                <span style="color: #E83A82;">for</span> (theta, phi) <span style="color: #E83A82;">in</span> angles:
                    run_sample(tng_src, gid, group=group,
                               out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                               grid_size=grid_size, fh=1, rng_seed=rng_seed,
                               rot=(theta, phi))
        gc.collect()
        <span style="color: #E83A82;">if</span> generate_stars:
            <span style="color: #FDB760;">group</span> = <span style="color: #44BC84;">"star"</span>
            <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">not</span> (out_path / group).exists():
                (out_path / group).mkdir(parents=<span style="color: #8787FF;">True</span>)
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"mkdir -p </span>{d.resolve()}<span style="color: #44BC84;">"</span>)
            <span style="color: #FDB760;">tng_src_star</span> = TNGGalaxy(tng_path, tng_id, halo_index=gids[0],
                                     particle_type=<span style="color: #44BC84;">'star'</span>, as_float32=<span style="color: #8787FF;">True</span>)
            <span style="color: #E83A82;">for</span> i, gid <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">enumerate</span>(gids):
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;"># Snapshot </span>{tng_id}<span style="color: #44BC84;">, subhalo </span>{gid}<span style="color: #44BC84;">, stars"</span>)
                <span style="color: #FDB760;">angles</span> = [] <span style="color: #E83A82;">if</span> rotations <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> rotations[i]
                run_sample(tng_src_star, gid, group=group,
                           out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                           grid_size=grid_size, fh=2, rng_seed=rng_seed, rot=<span style="color: #8787FF;">None</span>)
                <span style="color: #E83A82;">for</span> theta, phi <span style="color: #E83A82;">in</span> angles:
                    run_sample(tng_src_star, gid, group=group,
                               out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                               grid_size=grid_size, fh=2, rng_seed=rng_seed,
                               rot=(theta, phi))
            gc.collect()
        <span style="color: #E83A82;">if</span> generate_dm:
            <span style="color: #FDB760;">group</span> = <span style="color: #44BC84;">"dm"</span>
            <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">not</span> (out_path / group).exists():
                (out_path / group).mkdir(parents=<span style="color: #8787FF;">True</span>)
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"mkdir -p </span>{d.resolve()}<span style="color: #44BC84;">"</span>)
            <span style="color: #FDB760;">tng_src_dm</span> = TNGGalaxy(tng_path, tng_id, halo_index=gids[0],
                                   particle_type=<span style="color: #44BC84;">'dm'</span>, as_float32=<span style="color: #8787FF;">True</span>)
            <span style="color: #E83A82;">for</span> i, gid <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">enumerate</span>(gids):
                <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"</span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;"># Snapshot </span>{tng_id}<span style="color: #44BC84;">, subhalo </span>{gid}<span style="color: #44BC84;">, dark matter"</span>)
                <span style="color: #FDB760;">angles</span> = [] <span style="color: #E83A82;">if</span> rotations <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> rotations[i]
                run_sample(tng_src_dm, gid, group=group,
                           out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                           grid_size=grid_size, fh=3, rng_seed=rng_seed, rot=<span style="color: #8787FF;">None</span>)
                <span style="color: #E83A82;">for</span> theta, phi <span style="color: #E83A82;">in</span> angles:
                    run_sample(tng_src_dm, gid, group=group,
                               out_path=out_path, hdf5_name=hdf5_file, opt=opt,
                               grid_size=grid_size, fh=3, rng_seed=rng_seed,
                               rot=(theta, phi))
            gc.collect()


<span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">__name__</span> == <span style="color: #44BC84;">"__main__"</span>:
    <span style="color: #FDB760;">rng_seed</span> = 42
    np.random.seed(rng_seed)

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Options</span>
    <span style="color: #FDB760;">opt</span> = UtilOptions()
    <span style="color: #46D9FF;">print</span>(<span style="color: #44BC84;">"# Configs:"</span>)
    <span style="color: #FDB760;">_</span> = opt.print_options()

    <span style="color: #E83A82;">if</span> opt.output <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
        <span style="color: #FDB760;">hdf5_file</span> = <span style="color: #46D9FF;">str</span>(datetime.datetime.now().date()).replace(<span style="color: #44BC84;">'-'</span>, <span style="color: #44BC84;">''</span>) \
            + f<span style="color: #44BC84;">"_tng50-1_preproc.hdf5"</span>
    <span style="color: #E83A82;">else</span>:
        <span style="color: #FDB760;">hdf5_file</span> = opt.output

    <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Loop over all samples in all snapshots</span>
    main([50, 78, 99], <span style="color: #46D9FF;">range</span>(3334),
         groups=[<span style="color: #44BC84;">"gas"</span>, <span style="color: #44BC84;">"hi"</span>, <span style="color: #44BC84;">"hi/21cm"</span>, <span style="color: #44BC84;">"temp"</span>, <span style="color: #44BC84;">"bfield"</span>, <span style="color: #44BC84;">"star"</span>, <span style="color: #44BC84;">"dm"</span>],
         sim_path=<span style="color: #44BC84;">'./simulations'</span>, hdf5_file=hdf5_file, opt=opt,
         rng_seed=rng_seed,
         grid_size=512)

</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org6f7ad61">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org6f7ad61">Domains</h4>

<div id="org7714a69" class="figure">
<p><img src="./assets/images/skais/domains.png" alt="domains.png" height="830px" style="border-radius: 12px;" />
</p>
<p><span class="figure-number">Figure 4: </span>Dataset of over 30'000 x 6 galaxy maps</p>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org36a324f">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org36a324f">Domain translation</h4>

<div id="org6088e52" class="figure">
<p><img src="./assets/images/skais/domains_directions.png" alt="domains_directions.png" height="830px" style="border-radius: 12px;" />
</p>
<p><span class="figure-number">Figure 5: </span>Use image domain translation models: observations (21cm) &#x2194; physical properties</p>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org3f21178">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org3f21178">Units</h4>
<p>
Dynamic range between \(10^{-6} - 10^{12}\): transformation (often used in high-energy physics)
</p>

<div>
\begin{equation}
  \hat{x} = \left(\frac{x}{c}\right)^{(\frac{1}{\gamma})}
\end{equation}

</div>

<ul>
<li>\(c \gtrsim \max(x)\)</li>
<li>\(\gamma \sim 10^{1} - 10^{2}\)</li>

</ul>

<div class="gframe_row_col">
<div class="gframe_2col">

<div id="org70c30c1" class="figure">
<p><img src="./assets/images/skais/data_untransform.png" alt="data_untransform.png" height="500px" style="padding-left: 70px; border-radius: 12px;" />
</p>
</div>
</div>
<div class="gframe_2col">

<div id="org2c17da0" class="figure">
<p><img src="./assets/images/skais/data_transform.png" alt="data_transform.png" height="500px" style="padding-right: 200px; border-radius: 12px;" />
</p>
</div>
</div>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
<section>
<section id="slide-org6038e6c">
<div class="slide-header"><div style="height:100px"></div></div>
<h3 id="org6038e6c"><code>skais</code> for map-to-map transfer</h3>
<div class="org-src-container">

<pre class="src src-shell">skais
&#9500;&#9472;&#9472; LICENSE
&#9500;&#9472;&#9472; Makefile
&#9500;&#9472;&#9472; README.md
&#9500;&#9472;&#9472; README.org
&#9500;&#9472;&#9472; pyproject.toml
&#9500;&#9472;&#9472; requirements
&#9500;&#9472;&#9472; scripts
&#9500;&#9472;&#9472; setup.py
&#9500;&#9472;&#9472; skais
    &#9500;&#9472;&#9472; __init__.py
    &#9500;&#9472;&#9472; cast.py
    &#9500;&#9472;&#9472; cosmology.py
    &#9500;&#9472;&#9472; illustris
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; groupcat.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; snapshots.py
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; util.py
    &#9500;&#9472;&#9472; kernels.py
    &#9500;&#9472;&#9472; nn
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; data
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; loader.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; reader.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; sampler.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; transforms.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; losses.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; metrics.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; models
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; base.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; patchgan.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9500;&#9472;&#9472; pix2pix.py
    &#9474;&#160;&#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; unet.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; optimizers.py
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; options.py
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; utils
    &#9474;&#160;&#160;     &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160;     &#9500;&#9472;&#9472; ray.py
    &#9474;&#160;&#160;     &#9492;&#9472;&#9472; wandb.py
    &#9500;&#9472;&#9472; raytrace.c
    &#9500;&#9472;&#9472; raytrace.pyx
    &#9500;&#9472;&#9472; train.py
    &#9500;&#9472;&#9472; tune.py
    &#9500;&#9472;&#9472; utils
    &#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; colors.py
    &#9492;&#9472;&#9472; version.py
&#9500;&#9472;&#9472; skais.nn.conf.yml
&#9492;&#9472;&#9472; tests
</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org3d4c404">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org3d4c404">YAML config</h4>
<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Run id / name</span>
<span style="color: #FDB760;">defaults</span>:
  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">General</span>
  <span style="color: #8A8A8A;">###########</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Time when this file was initially created</span>
  <span style="color: #FDB760;">time</span>: 2023-04-03 17:08:45.714782
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Print more debugging information</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-v|--verbose]</span>
  <span style="color: #FDB760;">verbose</span>: <span style="color: #8787FF;">true</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Dry run the configuration</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-n|--dry-run]</span>
  <span style="color: #FDB760;">dry_run</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Name of this config</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-i|--config PATH]</span>
  <span style="color: #FDB760;">config</span>: skais.nn.conf.yml
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Path to the dataset(s)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-d|--data_dir PATH]</span>
  <span style="color: #FDB760;">data_dir</span>: ./data
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Path to the directory where the checkpoints are saved</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-c|--checkpoints_dir PATH]</span>
  <span style="color: #FDB760;">checkpoints_dir</span>: ./checkpoints
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Path to the results directory where plots and such are saved</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-o|--results_dir PATH]</span>
  <span style="color: #FDB760;">results_dir</span>: ./results
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Save checkpoints and artifacts in their respective directories in a tree-style format</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">to decrease number of files in a single folder.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--tree_structure]</span>
  <span style="color: #FDB760;">tree_structure</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">HDF5 dataset source file (if None, the lastest HDF5 file is used)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-f|--source|--file PATH]</span>
  <span style="color: #FDB760;">source</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Output filename, e.g. of merged HDF5 files (see ./scripts)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--out|--output PATH]</span>
  <span style="color: #FDB760;">output</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Data loading mode {hdf5, jpg, png, fits}  # TODO: so far only hdf5 implemented</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--data_mode MODE]</span>
  <span style="color: #FDB760;">data_mode</span>: hdf5
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Casting data type of the arrays/tensors {float32, float64, ...}</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--dtype DTYPE]</span>
  <span style="color: #FDB760;">dtype</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">GPUs: e.g. 0 or 0,1,2 or -1 for CPU</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-g|--gpu_ids GPU_IDs]</span>
  <span style="color: #FDB760;">gpu_ids</span>: 0

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Dataloader</span>
  <span style="color: #8A8A8A;">##############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Load aligned/paired datasets</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--aligned]</span>
  <span style="color: #FDB760;">aligned</span>: <span style="color: #8787FF;">true</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Input batch size</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--batch_size INT]</span>
  <span style="color: #FDB760;">batch_size</span>: 1
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, drops last batch in case batch_size doesn't fit into the dataset size</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--drop_last_batch]</span>
  <span style="color: #FDB760;">drop_last_batch</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, batch shuffling is disabled (reason for disabling could be performance)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--no_batch_shuffle]</span>
  <span style="color: #FDB760;">no_batch_shuffle</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of separate threads for loading data; 0 for stability (data loading in the main proc)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--data_threads]</span>
  <span style="color: #FDB760;">data_threads</span>: 0
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Train, validation, and test dataset split ratios</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--split SPLITS]</span>
  <span style="color: #FDB760;">split</span>: [0.7, 0.1, 0.2]
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">HDF5 groups to read out (two groups for paired image training, e.g. ["gas", "dm"]</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--file_groups GROUPS]</span>
  <span style="color: #FDB760;">file_groups</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Size of the entire HDF5 chunk cache for each dataset.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--chunk_cache SIZE]</span>
  <span style="color: #FDB760;">chunk_cache</span>: 2GB
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Chunk size of the HDF5 chunk cache. Leave None/null for auto-tuning</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--chunk_size SIZE]</span>
  <span style="color: #FDB760;">chunk_size</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Don't load the entire dataset into RAM</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--no_allcache]</span>
  <span style="color: #FDB760;">no_allcache</span>: <span style="color: #8787FF;">true</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Preprocessing methods, select from {max_scale, minmax_scale, log_scale, hep_scale}</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--preprocess METHODS]</span>
  <span style="color: #FDB760;">preprocess</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Global minimum of the dataset (if None, determined automatically -&gt; time-consuming)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--min_norm FLOATS]</span>
  <span style="color: #FDB760;">min_norm</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Global maximum of the dataset (if None, determined automatically -&gt; time-consuming)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--max_norm FLOATS]</span>
  <span style="color: #FDB760;">max_norm</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Log base (default natural log), choose from 'e', 2, 10</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--log_base BASES]</span>
  <span style="color: #FDB760;">log_base</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">inverse power for HEP scaler: (x/max_norm)**(1/hep_gamma)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--hep_gamma FLOATS]</span>
  <span style="color: #FDB760;">hep_gamma</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Flip the images for data augmentation;  # TODO: NotYetImplemented</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--flip] </span>
  <span style="color: #FDB760;">flip</span>: <span style="color: #8787FF;">false</span>

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Model</span>
  <span style="color: #8A8A8A;">##############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, model from starting epoch index will be loaded and wandb resumes logging</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-r|--reload]</span>
  <span style="color: #FDB760;">reload</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Model to be loaded: {pix2pix, }</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--model MODEL] </span>
  <span style="color: #FDB760;">model</span>: pix2pix
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Generator architecture</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--generator ARCH]</span>
  <span style="color: #FDB760;">generator</span>: unet
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Discriminator architecture (for GANs)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--discriminator ARCH]</span>
  <span style="color: #FDB760;">discriminator</span>: patchgan
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of input channels, e.g. 3 for RGB</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--in_channels INT]</span>
  <span style="color: #FDB760;">in_channels</span>: 1
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of output channels, e.g. 3 for RGB</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--out_channels INT]</span>
  <span style="color: #FDB760;">out_channels</span>: 1
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Filter/feature signature of the model</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--filters INTS]</span>
  <span style="color: #FDB760;">filters</span>: [64, 128, 256, 512]
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of downsampling blocks of the model</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--n_blocks INTS]</span>
  <span style="color: #FDB760;">n_blocks</span>: [1, 1, 1, 4]
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Kernel size of convolutions in model</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--kernel_size INT]</span>
  <span style="color: #FDB760;">kernel_size</span>: 4
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Dropout rate for the generator model; if None, no dropouts are used.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--dropouts FLOAT]</span>
  <span style="color: #FDB760;">dropouts</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Filter signature for the discriminator. If None, the generator's filter signature is used.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--filters_discriminator INTS]</span>
  <span style="color: #FDB760;">filters_discriminator</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of downsampling blocks for the discriminator. If None, the generator's blocks are used.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--n_blocks_discriminator INTS]</span>
  <span style="color: #FDB760;">n_blocks_discriminator</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Kernel size of convolutions in discriminator</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--kernel_size_discriminator INT]</span>
  <span style="color: #FDB760;">kernel_size_discriminator</span>: <span style="color: #8787FF;">null</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Network initialization method {normal|default, xavier, kaiming, fan_in, orthogonal}</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--init_methods METHOD]</span>
  <span style="color: #FDB760;">init_method</span>: normal
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Gain for the initialization methods normal, xavier, and orthogonal</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--init_gain FLOAT]</span>
  <span style="color: #FDB760;">init_gain</span>: 0.02
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, no batch normalization is performed in the generator/discriminator</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--no_batch_norm]</span>
  <span style="color: #FDB760;">no_batch_norm</span>: <span style="color: #8787FF;">False</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Loss terms, multiple choices possible: {ganloss, l1loss, l2loss}</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--loss LOSSES]</span>
  <span style="color: #FDB760;">loss</span>: [ganloss, l1loss]
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">regularization factor for L1 loss</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--lambda_l1 FLOAT]</span>
  <span style="color: #FDB760;">lambda_l1</span>: 1.0
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">GAN loss mode {vanilla|default|standard, lsgan, wgan|wganp|wgan-penalty|wgan_penalty}</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--gan_mode METHOD]</span>
  <span style="color: #FDB760;">gan_mode</span>: vanilla
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Direction for paired image training {AtoB|BtoA} (alternatively reverse file_groups list)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--direction DIR]</span>
  <span style="color: #FDB760;">direction</span>: AtoB

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Optimizer</span>
  <span style="color: #8A8A8A;">##############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Optimizer for training (adam, sgd, adagrad, rmsprop, adamw)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">--optimizer_type METHOD</span>
  <span style="color: #FDB760;">optimizer_type</span>: adam
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Learning rate; can be list of values if model has multiple networks</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--lr RATES]</span>
  <span style="color: #FDB760;">lr</span>: 0.0002
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">First moment decay parameter for the Adam(w) optimizer</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--beta1 FLOAT]</span>
  <span style="color: #FDB760;">beta1</span>: 0.5
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Second moment decay parameter for the Adam(w) optimizer</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--beta2 FLOAT]</span>
  <span style="color: #FDB760;">beta2</span>: 0.999
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Momentum of the SGD optimizer</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--momentum FLOAT]</span>
  <span style="color: #FDB760;">momentum</span>: 0
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Learning rate schedule (invariant, constant, linear, step, step_50, step_90, plateau, cosine)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--lr_schedule SCHEDULE]</span>
  <span style="color: #FDB760;">lr_schedule</span>: invariant
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Decay parameter (determines either the decay periodicity or milestone) in epochs</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--lr_decay INT]</span>
  <span style="color: #FDB760;">lr_decay</span>: 50
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Decay factor; behaviour depends on exact scheduler</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--gamma FLOAT]</span>
  <span style="color: #FDB760;">gamma</span>: <span style="color: #8787FF;">null</span>

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Training</span>
  <span style="color: #8A8A8A;">############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Training mode flag (if False, models are loaded without optimizers)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-t|--train]</span>
  <span style="color: #FDB760;">train</span>: <span style="color: #8787FF;">true</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Starting index of training epochs (important to specify when loading intermediate checkpoints)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-s|--epoch_start INT]</span>
  <span style="color: #FDB760;">epoch_start</span>: 0
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of total training epochs</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--n_epochs INT]</span>
  <span style="color: #FDB760;">n_epochs</span>: 300
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, ray.tune callbacks are used.</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--use_ray]</span>
  <span style="color: #FDB760;">use_ray</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of maximum epochs to train models in ray.tune sweeps [epochs].</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_raytune INT]</span>
  <span style="color: #FDB760;">t_raytune</span>: 50
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">If True, wandb logging is used during training</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--use_wandb]</span>
  <span style="color: #FDB760;">use_wandb</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Specify wandb project name</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--wandb_project_name NAME]</span>
  <span style="color: #FDB760;">wandb_project_name</span>: skais_defaults
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">wandb logging frequency in numbers of iterations</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_wandb INT]</span>
  <span style="color: #FDB760;">t_wandb</span>: 1
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Log frequency in no. of batched iterations, i.e. total no. of iter. per epoch: len(dataset) / batch_size)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_log INT]</span>
  <span style="color: #FDB760;">t_log</span>: 100
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Checkpoint saving in number of epochs (*.latest.pth file use cached at the end of every epoch)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_checkpoints INT]</span>
  <span style="color: #FDB760;">t_checkpoint</span>: 5
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Output (e.g. image predicitions) frequency in numbers of epochs</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_output INT]</span>
  <span style="color: #FDB760;">t_output</span>: 10
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Evaluation frequency during training in number of epochs</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--t_eval INT]</span>
  <span style="color: #FDB760;">t_eval</span>: 1

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Evaluation / Inference</span>
  <span style="color: #8A8A8A;">###############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Run in evaluation mode (for train/test)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--eval]</span>
  <span style="color: #FDB760;">eval</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Calculate metrics [MSE, Chi2, PSNR, SSIM]</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--eval_metrics METRICS]</span>
  <span style="color: #FDB760;">eval_metrics</span>: []
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of sample images for manual post-hoc inspection</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--eval_samples INT]</span>
  <span style="color: #FDB760;">eval_samples</span>: 0
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Run in test mode (for __main__)  # TODO: NotYetImplemented</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--test]</span>
  <span style="color: #FDB760;">test</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Number of test samples to run;  # TODO: NotYetImplemented</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--num_test INT]</span>
  <span style="color: #FDB760;">num_test</span>: 1

  <span style="color: #8A8A8A;">### </span><span style="color: #8A8A8A;">Utility: Evaluation, Inference, Unittests, ImgH5Buffer</span>
  <span style="color: #8A8A8A;">###############</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Unittest flag  # TODO: NotYetImplemented... I think</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-u|--unittest]</span>
  <span style="color: #FDB760;">unittest</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Util mode flag (used in several scripts)</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[-a|--util]</span>
  <span style="color: #FDB760;">util</span>: <span style="color: #8787FF;">false</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">File extensions for Img2H5Buffer's automatic file search</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--file_extensions EXT]</span>
  <span style="color: #FDB760;">file_extensions</span>: [hdf5]
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">File signatures to look for in Img2H5Buffer's automatic file search</span>
  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">[--fiile_signatures PATTERN]</span>
  <span style="color: #FDB760;">file_signatures</span>: <span style="color: #8787FF;">null</span>

</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-orge3801f1">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="orge3801f1">pix2pix.py</h4>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">SKAIs nn.models.pix2pix module</span>

<span style="color: #44BC84;">@author: phdenzel</span>
<span style="color: #44BC84;">"""</span>
<span style="color: #E83A82;">import</span> torch
<span style="color: #E83A82;">from</span> skais.nn <span style="color: #E83A82;">import</span> init_module
<span style="color: #E83A82;">from</span> skais.nn.models.base <span style="color: #E83A82;">import</span> BaseModel
<span style="color: #E83A82;">from</span> skais.nn.options <span style="color: #E83A82;">import</span> Options


<span style="color: #46D9FF;">__all__</span> = [<span style="color: #44BC84;">'Pix2Pix'</span>,]


<span style="color: #E83A82;">class</span> <span style="color: #FFD787;">Pix2Pix</span>(BaseModel):
    <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">    Pix2Pix model based on https://arxiv.org/abs/1611.07004</span>
<span style="color: #44BC84;">    """</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">__init__</span>(<span style="color: #E83A82;">self</span>, options: Options.atype(),
                 generator: <span style="color: #46D9FF;">callable</span> = <span style="color: #8787FF;">None</span>,
                 discriminator: <span style="color: #46D9FF;">callable</span> = <span style="color: #8787FF;">None</span>,
                 loss_funcs: <span style="color: #46D9FF;">list</span>[<span style="color: #46D9FF;">callable</span>] = <span style="color: #8787FF;">None</span>):
        <span style="color: #46D9FF;">super</span>().__init__(options)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">patch option requirements</span>
        <span style="color: #E83A82;">self</span>.patch_options(model=<span style="color: #44BC84;">'pix2pix'</span>, loss=[<span style="color: #44BC84;">'ganloss'</span>, <span style="color: #44BC84;">'l1loss'</span>, <span style="color: #44BC84;">'l2loss'</span>])
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">define networks as [generator, discriminator]</span>
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.verbose:
            <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"# Initializing </span>{<span style="color: #E83A82;">self</span>.__class__.<span style="color: #46D9FF;">__name__</span>}<span style="color: #44BC84;">"</span>)
        <span style="color: #FDB760;">generator</span> = <span style="color: #44BC84;">'generator'</span> <span style="color: #E83A82;">if</span> generator <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> generator
        <span style="color: #FDB760;">generator</span> = init_module(generator, <span style="color: #E83A82;">self</span>.options, verbose=<span style="color: #E83A82;">self</span>.verbose)
        <span style="color: #E83A82;">self</span>.networks.append(generator)
        <span style="color: #FDB760;">discriminator</span> = <span style="color: #44BC84;">'discriminator'</span> <span style="color: #E83A82;">if</span> discriminator <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> discriminator
        <span style="color: #FDB760;">filters</span> = <span style="color: #E83A82;">self</span>.options.filters
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.options.filters_discriminator <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">filters</span> = <span style="color: #E83A82;">self</span>.options.filters_discriminator
        <span style="color: #FDB760;">n_blocks</span> = <span style="color: #E83A82;">self</span>.options.n_blocks
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.options.n_blocks <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">n_blocks</span> = <span style="color: #E83A82;">self</span>.options.n_blocks_discriminator
        <span style="color: #FDB760;">kernel_size</span> = <span style="color: #E83A82;">self</span>.options.kernel_size
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.options.kernel_size_discriminator <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #FDB760;">kernel_size</span> = <span style="color: #E83A82;">self</span>.options.kernel_size_discriminator
        <span style="color: #FDB760;">discriminator</span> = init_module(discriminator, <span style="color: #E83A82;">self</span>.options,
                                    in_channels=<span style="color: #E83A82;">self</span>.in_channels+<span style="color: #E83A82;">self</span>.out_channels,
                                    filters=filters, n_blocks=n_blocks, kernel_size=kernel_size,
                                    verbose=<span style="color: #E83A82;">self</span>.verbose)
        <span style="color: #E83A82;">self</span>.networks.append(discriminator)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">loss functions</span>
        <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">loss</span> = {<span style="color: #44BC84;">'G'</span>: {<span style="color: #44BC84;">'L'</span>: 0, <span style="color: #44BC84;">'gan'</span>: 0, <span style="color: #44BC84;">'l1'</span>: 0, <span style="color: #44BC84;">'l2'</span>: 0},
                     <span style="color: #44BC84;">'D'</span>: {<span style="color: #44BC84;">'L'</span>: 0, <span style="color: #44BC84;">'fake'</span>: 0, <span style="color: #44BC84;">'real'</span>: 0}}
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.training:
            <span style="color: #FDB760;">loss_funcs</span> = <span style="color: #44BC84;">'loss'</span> <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">not</span> loss_funcs <span style="color: #E83A82;">else</span> loss_funcs
            <span style="color: #FDB760;">loss_funcs</span> = init_module(loss_funcs, options, verbose=<span style="color: #E83A82;">self</span>.verbose)
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">loss_funcs</span> += loss_funcs
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">add optimizers corresponding to networks</span>
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.training:
            <span style="color: #FDB760;">lrs</span> = <span style="color: #E83A82;">self</span>.options.lr
            <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">not</span> <span style="color: #46D9FF;">isinstance</span>(<span style="color: #E83A82;">self</span>.options.lr, <span style="color: #46D9FF;">list</span>):
                <span style="color: #FDB760;">lrs</span> = [<span style="color: #E83A82;">self</span>.options.lr]*<span style="color: #46D9FF;">len</span>(<span style="color: #E83A82;">self</span>.networks)
            <span style="color: #E83A82;">for</span> lr, network <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">zip</span>(lrs, <span style="color: #E83A82;">self</span>.networks):
                <span style="color: #FDB760;">optimizer</span> = init_module(<span style="color: #44BC84;">'Optimizer'</span>, options=<span style="color: #E83A82;">self</span>.options,
                                        verbose=<span style="color: #E83A82;">self</span>.verbose, network=network, lr=lr)
                <span style="color: #E83A82;">self</span>.optimizers.append(optimizer)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">initialize learning rate schedulers</span>
        <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.training:
            <span style="color: #E83A82;">for</span> network, optimizer <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">zip</span>(<span style="color: #E83A82;">self</span>.networks, <span style="color: #E83A82;">self</span>.optimizers):
                <span style="color: #FDB760;">scheduler</span> = init_module(Pix2Pix.get_scheduler, options=<span style="color: #E83A82;">self</span>.options,
                                        verbose=<span style="color: #E83A82;">self</span>.verbose, optimizer=optimizer)
                <span style="color: #E83A82;">self</span>.schedulers.append(scheduler)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">run setup</span>
        <span style="color: #E83A82;">self</span>.init()

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">generator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.networks[0]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">discriminator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.networks[1]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">optimizer_generator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.optimizers[0]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">optimizer_discriminator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.optimizers[1]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">gan_loss</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.loss_funcs[0]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">l1_loss</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.loss_funcs[1]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">l2_loss</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Note: not used for backprop</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.loss_funcs[2]

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">lambda_l1</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #FDB760;">l_l1</span> = <span style="color: #E83A82;">self</span>.options.lambda_l1
        <span style="color: #E83A82;">if</span> l_l1 <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #E83A82;">return</span> l_l1
        <span style="color: #E83A82;">return</span> 1

    @<span style="color: #46D9FF;">property</span>
    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">direction</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.options.direction

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">log_loss</span>(<span style="color: #E83A82;">self</span>, verbose: <span style="color: #46D9FF;">bool</span> = <span style="color: #8787FF;">False</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Format the model loss for logging/printing</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #FDB760;">loss</span> = <span style="color: #E83A82;">self</span>.loss.copy()
        <span style="color: #E83A82;">if</span> verbose:
            <span style="color: #FDB760;">loss_msg</span> = (
                f<span style="color: #44BC84;">"Loss (generator) | </span>{'':9}<span style="color: #44BC84;"> GAN / L1 </span>{'':10}<span style="color: #44BC84;"> "</span>
                f<span style="color: #44BC84;">"|  Loss (discriminator) | </span>{'':11}<span style="color: #44BC84;"> 0 / 1 </span><span style="color: #8787FF;">\n</span><span style="color: #44BC84;">"</span>
                f<span style="color: #44BC84;">"</span>{loss['G']['L']:16.6f}<span style="color: #44BC84;"> | "</span>
                f<span style="color: #44BC84;">"</span>{loss['G']['gan']:10.6f}<span style="color: #44BC84;"> / </span>{loss['G']['l1']:16.6f}<span style="color: #44BC84;"> |"</span>
                f<span style="color: #44BC84;">"</span>{loss['D']['L']:22.6f}<span style="color: #44BC84;"> | "</span>
                f<span style="color: #44BC84;">"</span>{loss['D']['fake']:13.6f}<span style="color: #44BC84;"> / </span>{loss['D']['real']:13.6f}<span style="color: #44BC84;">"</span>)
            <span style="color: #46D9FF;">print</span>(loss_msg)
        <span style="color: #E83A82;">return</span> loss

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">sample_images</span>(<span style="color: #E83A82;">self</span>, n_samples: <span style="color: #46D9FF;">int</span> = <span style="color: #8787FF;">None</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Select (modelled) images for logging</span>

<span style="color: #44BC84;">        Args:</span>
<span style="color: #44BC84;">          n_samples (int): Number of samples to draw from the batch</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #FDB760;">batch_size</span> = <span style="color: #E83A82;">self</span>.in_data.shape[0]
        <span style="color: #E83A82;">if</span> n_samples <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #E83A82;">return</span> {
                0: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.in_data, <span style="color: #44BC84;">"metadata"</span>: <span style="color: #E83A82;">self</span>.in_metadata},
                1: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.gt_data, <span style="color: #44BC84;">"metadata"</span>: <span style="color: #E83A82;">self</span>.gt_metadata},
                <span style="color: #44BC84;">"pred"</span>: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.out_data, <span style="color: #44BC84;">"metadata"</span>: <span style="color: #E83A82;">self</span>.out_metadata}}
        <span style="color: #FDB760;">n_samples</span> = <span style="color: #46D9FF;">min</span>(n_samples, <span style="color: #46D9FF;">len</span>(<span style="color: #E83A82;">self</span>.in_data))
        <span style="color: #FDB760;">idx</span> = torch.ones(batch_size).multinomial(n_samples, replacement=<span style="color: #8787FF;">True</span>)
        <span style="color: #E83A82;">return</span> {
            0: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.in_data[idx],
                <span style="color: #44BC84;">"metadata"</span>: {k: v[idx] <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(v, torch.Tensor)
                             <span style="color: #E83A82;">else</span> [v[i] <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> idx]
                             <span style="color: #E83A82;">for</span> k, v <span style="color: #E83A82;">in</span> <span style="color: #E83A82;">self</span>.in_metadata.items()}},
            1: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.gt_data[idx],
                <span style="color: #44BC84;">"metadata"</span>: {k: v[idx] <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(v, torch.Tensor)
                             <span style="color: #E83A82;">else</span> [v[i] <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> idx]
                             <span style="color: #E83A82;">for</span> k, v <span style="color: #E83A82;">in</span> <span style="color: #E83A82;">self</span>.gt_metadata.items()}},
            <span style="color: #44BC84;">"pred"</span>: {<span style="color: #44BC84;">"data"</span>: <span style="color: #E83A82;">self</span>.out_data[idx],
                     <span style="color: #44BC84;">"metadata"</span>: {k: v[idx] <span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">isinstance</span>(v, torch.Tensor)
                                  <span style="color: #E83A82;">else</span> [v[i] <span style="color: #E83A82;">for</span> i <span style="color: #E83A82;">in</span> idx]
                                  <span style="color: #E83A82;">for</span> k, v <span style="color: #E83A82;">in</span> <span style="color: #E83A82;">self</span>.out_metadata.items()}}}

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">init</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">load network weights from checkpoints</span>
        <span style="color: #FDB760;">use_ckpts</span> = <span style="color: #E83A82;">self</span>.options.<span style="color: #46D9FF;">reload</span>
        <span style="color: #FDB760;">epoch</span> = <span style="color: #E83A82;">self</span>.options.epoch_start
        <span style="color: #E83A82;">for</span> i, network <span style="color: #E83A82;">in</span> <span style="color: #46D9FF;">enumerate</span>(<span style="color: #E83A82;">self</span>.networks):
            <span style="color: #FDB760;">f</span> = <span style="color: #E83A82;">self</span>.checkpoints_dir.rglob(<span style="color: #E83A82;">self</span>.savename(i, epoch <span style="color: #E83A82;">if</span> epoch <span style="color: #E83A82;">else</span> <span style="color: #8787FF;">None</span>))
            <span style="color: #E83A82;">try</span>:
                <span style="color: #FDB760;">fstr</span> = <span style="color: #46D9FF;">str</span>(<span style="color: #46D9FF;">next</span>(f))
            <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">StopIteration</span>:
                <span style="color: #FDB760;">fstr</span> = <span style="color: #8787FF;">None</span>
            <span style="color: #E83A82;">if</span> use_ckpts <span style="color: #E83A82;">and</span> fstr:
                <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.verbose:
                    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Found [checkpoint]: </span>{fstr}<span style="color: #44BC84;">"</span>)
                <span style="color: #E83A82;">self</span>.load_networks(flags=[<span style="color: #E83A82;">self</span>.uid], epoch=epoch, verbose=<span style="color: #E83A82;">self</span>.verbose)
            <span style="color: #E83A82;">elif</span> use_ckpts:  <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">but checkpoint file not found, print out warning and use latest</span>
                <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.verbose:
                    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Warning! Could not find [checkpoint]: </span>{fstr}<span style="color: #44BC84;">"</span>)
                    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Trying [checkpoint:latest] instead (make sure epoch is correctly set)..."</span>)
                <span style="color: #FDB760;">f</span> = <span style="color: #E83A82;">self</span>.checkpoints_dir.rglob(<span style="color: #E83A82;">self</span>.savename(i))
                <span style="color: #E83A82;">try</span>:
                    <span style="color: #FDB760;">fstr</span> = <span style="color: #46D9FF;">str</span>(<span style="color: #46D9FF;">next</span>(f))
                <span style="color: #E83A82;">except</span> <span style="color: #FFD787;">StopIteration</span>:
                    <span style="color: #FDB760;">fstr</span> = <span style="color: #8787FF;">None</span>
                <span style="color: #E83A82;">if</span> fstr:
                    <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.verbose:
                        <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Found [checkpoint]: </span>{fstr}<span style="color: #44BC84;">"</span>)
                    <span style="color: #E83A82;">self</span>.load_networks(flags=[<span style="color: #E83A82;">self</span>.uid], verbose=<span style="color: #E83A82;">self</span>.verbose)
            <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">or initialize network weights from scratch</span>
            <span style="color: #E83A82;">else</span>:
                <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.verbose:
                    <span style="color: #46D9FF;">print</span>(f<span style="color: #44BC84;">"Initializing [</span>{network.__class__.<span style="color: #46D9FF;">__name__</span>}<span style="color: #44BC84;">]:"</span>)
                init_module(Pix2Pix.init_weights, options=<span style="color: #E83A82;">self</span>.options,
                            verbose=<span style="color: #E83A82;">self</span>.verbose, network=network)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">move to the corresponding device</span>
        <span style="color: #E83A82;">self</span>.to(device=<span style="color: #E83A82;">self</span>.device)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">initialize data attributes</span>
        <span style="color: #E83A82;">self</span>.load_data(<span style="color: #8787FF;">None</span>)

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">load_data</span>(<span style="color: #E83A82;">self</span>, batch: <span style="color: #46D9FF;">dict</span>[torch.Tensor]):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Load data batch as input (in) and ground truth (gt) for the networks</span>

<span style="color: #44BC84;">        Args:</span>
<span style="color: #44BC84;">          batch (dict): batch containing data tensors with following convention</span>
<span style="color: #44BC84;">                        {0: {'data': tensor, 'metadata': dict},</span>
<span style="color: #44BC84;">                         1: {'data': tensor, 'metadata': dict},</span>
<span style="color: #44BC84;">                         ... }</span>
<span style="color: #44BC84;">        Sets:</span>
<span style="color: #44BC84;">          (torch.Tensor): in_data, gt_data</span>
<span style="color: #44BC84;">          (dict): in_metadata, gt_metadata</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #E83A82;">if</span> batch <span style="color: #E83A82;">is</span> <span style="color: #8787FF;">None</span>:
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">in_data</span> = torch.tensor([0])
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">gt_data</span> = torch.tensor([0])
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">in_metadata</span> = <span style="color: #E83A82;">self</span>.out_metadata = {}
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">gt_metadata</span> = {}
        <span style="color: #E83A82;">else</span>:
            <span style="color: #FDB760;">AtoB</span> = 0 <span style="color: #E83A82;">if</span> <span style="color: #E83A82;">self</span>.direction == <span style="color: #44BC84;">'AtoB'</span> <span style="color: #E83A82;">else</span> 1
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">in_data</span> = batch[AtoB][<span style="color: #44BC84;">'data'</span>].to(<span style="color: #E83A82;">self</span>.device)
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">gt_data</span> = batch[1-AtoB][<span style="color: #44BC84;">'data'</span>].to(<span style="color: #E83A82;">self</span>.device)
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">in_metadata</span> = batch[AtoB][<span style="color: #44BC84;">'metadata'</span>]
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">gt_metadata</span> = batch[1-AtoB][<span style="color: #44BC84;">'metadata'</span>]
            <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">out_metadata</span> = batch[1-AtoB][<span style="color: #44BC84;">'metadata'</span>].copy()

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">forward</span>(<span style="color: #E83A82;">self</span>, x: torch.Tensor = <span style="color: #8787FF;">None</span>, **kwargs) -&gt; torch.Tensor:
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Forward step for all networks</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #FDB760;">x</span> = x <span style="color: #E83A82;">if</span> x <span style="color: #E83A82;">is</span> <span style="color: #E83A82;">not</span> <span style="color: #8787FF;">None</span> <span style="color: #E83A82;">else</span> <span style="color: #E83A82;">self</span>.in_data
        <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">out_data</span> = <span style="color: #E83A82;">self</span>.generator(x)
        <span style="color: #E83A82;">return</span> <span style="color: #E83A82;">self</span>.out_data

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">optimize</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Propagate forward, calculate losses, gradients, and update network weights</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #E83A82;">self</span>.<span style="color: #FDB760;">out_data</span> = <span style="color: #E83A82;">self</span>.forward(<span style="color: #E83A82;">self</span>.in_data)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">backpropagation for discriminator</span>
        <span style="color: #E83A82;">self</span>.optimize_discriminator()
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">backpropagation for generator</span>
        <span style="color: #E83A82;">self</span>.optimize_generator()

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">optimize_generator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">backpropagation for generator</span>
        <span style="color: #E83A82;">self</span>.requires_grad(<span style="color: #8787FF;">False</span>, <span style="color: #E83A82;">self</span>.discriminator)
        <span style="color: #E83A82;">self</span>.optimizer_generator.zero_grad()
        <span style="color: #E83A82;">self</span>.backward_generator()
        <span style="color: #E83A82;">self</span>.optimizer_generator.step()

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">optimize_discriminator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">backpropagation for discriminator</span>
        <span style="color: #E83A82;">self</span>.requires_grad(<span style="color: #8787FF;">True</span>, <span style="color: #E83A82;">self</span>.discriminator)
        <span style="color: #E83A82;">self</span>.optimizer_discriminator.zero_grad()
        <span style="color: #E83A82;">self</span>.backward_discriminator()
        <span style="color: #E83A82;">self</span>.optimizer_discriminator.step()

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">backward_generator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Backwards propagation for the generator network</span>
<span style="color: #44BC84;">        (assumes a forward pass was made)</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">PatchGAN loss</span>
        <span style="color: #FDB760;">fake_io</span> = torch.cat((<span style="color: #E83A82;">self</span>.in_data, <span style="color: #E83A82;">self</span>.out_data), 1)
        <span style="color: #FDB760;">pred_fake</span> = <span style="color: #E83A82;">self</span>.discriminator(fake_io)
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'G'</span>][<span style="color: #44BC84;">'gan'</span>] = loss_gan = <span style="color: #E83A82;">self</span>.gan_loss(pred_fake, <span style="color: #8787FF;">True</span>)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">L1 reconstruction loss</span>
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'G'</span>][<span style="color: #44BC84;">'l1'</span>] = loss_l1 = <span style="color: #E83A82;">self</span>.l1_loss(<span style="color: #E83A82;">self</span>.out_data, <span style="color: #E83A82;">self</span>.gt_data) * <span style="color: #E83A82;">self</span>.lambda_l1
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">tally up and calculate gradients</span>
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'G'</span>][<span style="color: #44BC84;">'L'</span>] = loss_gan + loss_l1
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'G'</span>][<span style="color: #44BC84;">'L'</span>].backward()
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">just for book-keeping</span>
        <span style="color: #E83A82;">with</span> torch.no_grad():
            <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'G'</span>][<span style="color: #44BC84;">'l2'</span>] = <span style="color: #E83A82;">self</span>.l2_loss(<span style="color: #E83A82;">self</span>.out_data, <span style="color: #E83A82;">self</span>.gt_data)

    <span style="color: #E83A82;">def</span> <span style="color: #5F8AF7;">backward_discriminator</span>(<span style="color: #E83A82;">self</span>):
        <span style="color: #44BC84;">"""</span>
<span style="color: #44BC84;">        Backwards propagation for the discriminator network</span>
<span style="color: #44BC84;">        (assumes a forward pass was made)</span>
<span style="color: #44BC84;">        """</span>
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Fake</span>
        <span style="color: #FDB760;">fake_io</span> = torch.cat((<span style="color: #E83A82;">self</span>.in_data, <span style="color: #E83A82;">self</span>.out_data), 1)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">stop backprop to the generator by detaching out_data</span>
        <span style="color: #FDB760;">pred_fake</span> = <span style="color: #E83A82;">self</span>.discriminator(fake_io.detach())
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'D'</span>][<span style="color: #44BC84;">'fake'</span>] = loss_fake = <span style="color: #E83A82;">self</span>.gan_loss(pred_fake, <span style="color: #8787FF;">False</span>)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">Real</span>
        <span style="color: #FDB760;">real_io</span> = torch.cat((<span style="color: #E83A82;">self</span>.in_data, <span style="color: #E83A82;">self</span>.gt_data), 1)
        <span style="color: #FDB760;">pred_real</span> = <span style="color: #E83A82;">self</span>.discriminator(real_io)
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'D'</span>][<span style="color: #44BC84;">'real'</span>] = loss_real = <span style="color: #E83A82;">self</span>.gan_loss(pred_real, <span style="color: #8787FF;">True</span>)
        <span style="color: #8A8A8A;"># </span><span style="color: #8A8A8A;">tally up and calculate gradients</span>
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'D'</span>][<span style="color: #44BC84;">'L'</span>] = loss = (loss_fake + loss_real) * 0.5
        <span style="color: #E83A82;">self</span>.loss[<span style="color: #44BC84;">'D'</span>][<span style="color: #44BC84;">'L'</span>].backward()


<span style="color: #E83A82;">if</span> <span style="color: #46D9FF;">__name__</span> == <span style="color: #44BC84;">"__main__"</span>:
    <span style="color: #E83A82;">import</span> sys
    sys.path.append(<span style="color: #44BC84;">'../../../tests'</span>)
    <span style="color: #E83A82;">from</span> tests <span style="color: #E83A82;">import</span> SequentialTestLoader
    <span style="color: #E83A82;">from</span> tests.nn.models.pix2pix <span style="color: #E83A82;">import</span> Pix2PixModuleTest
    <span style="color: #FDB760;">loader</span> = SequentialTestLoader()
    loader.proto_load(Pix2PixModuleTest)
    loader.run_suites()
</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org2cfefe0">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org2cfefe0">Results</h4>
<p>
Ground truth  <br> 
</p>
<p height="830px">
<img src="./assets/images/skais/dm_predictions.png" alt="dm_predictions.png" height="830px" />
 <br>  Predictions from pix2pix
</p>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org98a6d18">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org98a6d18">Hyperparameter optimization</h4>
<ul>
<li><code>wandb</code>: basic, conditional parameter spaces don't work</li>
<li><code>ray[tune]</code>:
<ul>
<li>parallel, distributed</li>
<li>early-stopping and improved error handling</li>
<li>conditional parameter spaces</li>
<li>multiple algorithms (Bayesian + genetic)</li>
<li>interfaces for HyperOpt, Optuna, BayesOpt, &#x2026;</li>

</ul></li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org1fac96d">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org1fac96d">tune.py</h4>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #E83A82;">import</span> ray
<span style="color: #E83A82;">from</span> ray <span style="color: #E83A82;">import</span> train
<span style="color: #E83A82;">from</span> ray <span style="color: #E83A82;">import</span> tune
<span style="color: #E83A82;">from</span> skais.train <span style="color: #E83A82;">import</span> trainable
<span style="color: #E83A82;">from</span> skais.nn.options <span style="color: #E83A82;">import</span> Options
<span style="color: #E83A82;">from</span> skais.nn.utils.ray <span style="color: #E83A82;">import</span> link_condition

<span style="color: #FDB760;">options</span> = Options()
<span style="color: #FDB760;">all_params</span> = options.sweep_params
<span style="color: #FDB760;">all_samplers</span> = options.sweep_samplers
<span style="color: #FDB760;">all_priors</span> = options.sweep_priors
<span style="color: #FDB760;">space</span> = {}
<span style="color: #E83A82;">for</span> key <span style="color: #E83A82;">in</span> all_params:
    <span style="color: #FDB760;">fn_str</span> = all_samplers[key]
    <span style="color: #FDB760;">fn_args</span> = all_priors[key]
    <span style="color: #FDB760;">args</span> = {<span style="color: #44BC84;">'param'</span>: key, <span style="color: #44BC84;">'fn_str'</span>: fn_str, <span style="color: #44BC84;">'fn_args'</span>: fn_args}
    <span style="color: #FDB760;">subspace</span> = link_condition(**args)
<span style="color: #FDB760;">space</span> = {**space, **subspace}
<span style="color: #FDB760;">tuner</span> = tune.Tuner(
    tune.with_resources(trainable, {<span style="color: #44BC84;">"cpu"</span>: 1}),
    param_space=space,
    tune_config=tune.TuneConfig(num_samples=6,),
    run_config=train.RunConfig(log_to_file=<span style="color: #8787FF;">True</span>, name=<span style="color: #44BC84;">"test_experiment"</span>,
                               storage_path=<span style="color: #46D9FF;">str</span>(<span style="color: #E83A82;">self</span>.ray_dir.resolve())))
tuner.fit()
</pre>
</div>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
<section id="slide-org15bd1cb">
<div class="slide-header"><div style="height:100px"></div></div>
<h4 id="org15bd1cb">Room for improvement</h4>
<ul>
<li>luckily, <code>skais</code> is relatively modular</li>
<li>other models: diffusion</li>
<li>proposal for IVS collaboration: separate models repository!</li>

</ul>
<div class="slide-footer"><div style="height:100px"></div></div>
</section>
</section>
</div>
</div>
<div> Created by phdenzel. </div>
<script src="file:///Users/phdenzel/local/reveal.js/dist/reveal.js"></script>
<script src="file:///Users/phdenzel/local/reveal.js/plugin/markdown/markdown.js"></script>
<script src="file:///Users/phdenzel/local/reveal.js/plugin/math/math.js"></script>
<script src="file:///Users/phdenzel/local/reveal.js/plugin/zoom/zoom.js"></script>
<script src="file:///Users/phdenzel/local/reveal.js/plugin/notes/notes.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: true,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,
overview: true,
width: 1920,
height: 1080,
margin: 0.05,
minScale: 0.20,
maxScale: 4.50,

transition: 'slide',
transitionSpeed: 'default',
controlsLayout: 'bottom-right', controlsBackArrows: 'faded', navigationMode: 'linear', previewLinks: false,

// Plugins with reveal.js 4.x
plugins: [ RevealMarkdown, RevealMath, RevealZoom, RevealNotes ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
